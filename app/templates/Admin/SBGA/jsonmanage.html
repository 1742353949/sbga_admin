<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON数据管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-info {
            background-color: #17a2b8;
        }
        .btn-info:hover {
            background-color: #138496;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #e9ecef;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .module-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .module-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .module-card h3 {
            margin-top: 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            color: red;
            padding: 10px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .file-item {
            padding: 10px 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-item.active {
            background-color: #007bff;
            color: white;
        }
        .actions {
            margin: 20px 0;
        }
        .module-editor {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .item-editor {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #ffffff;
        }
        .nested-item {
            margin-left: 20px;
            border-left: 2px solid #ddd;
            padding-left: 10px;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .json-preview {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .field-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .field-row input, .field-row select {
            flex: 1;
        }
        .field-row .btn {
            flex: 0 0 auto;
        }
        .custom-field {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .custom-field input {
            flex: 1;
        }
        .custom-fields-container {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }
        .table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .editable-cell {
            padding: 5px;
            border: 1px solid transparent;
        }
        .editable-cell:hover {
            border: 1px solid #007bff;
            cursor: pointer;
        }
        .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 2px;
        }
        .list-editor {
            margin: 15px 0;
        }
        .list-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .list-item input {
            flex: 1;
        }
        .multi-value-item {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .multi-value-item > div {
            flex: 1;
            min-width: 200px;
        }
        .multi-value-item .item-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .multi-value-item .item-value {
            color: #555;
        }
        /* 新增样式：用于显示嵌套数据 */
        .nested-data-container {
            margin-left: 20px;
            border-left: 2px solid #007bff;
            padding-left: 15px;
        }
        .data-node {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #fafafa;
        }
        .data-node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .data-node-title {
            font-weight: bold;
        }
        .data-node-controls {
            display: flex;
            gap: 5px;
        }
        .property-editor {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .property-field {
            flex: 1;
            min-width: 200px;
        }
        .property-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .property-field input, .property-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .toggle-children {
            cursor: pointer;
            color: #007bff;
            font-weight: bold;
        }
        .children-container {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .property-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .property-label {
            font-weight: normal;
        }
        .property-value {
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>JSON数据管理</h1>
        
        <!-- 导航标签 -->
        <div class="tabs">
            <div class="tab active" data-tab="view">数据查看</div>
            <div class="tab" data-tab="edit">数据编辑</div>
            <div class="tab" data-tab="create">创建JSON文件</div>
        </div>
        
        <!-- 数据查看标签内容 -->
        <div class="tab-content active" id="view-tab">
            <div class="section">
                <div class="section-title">选择文件</div>
                <div class="file-list" id="fileList">
                    <!-- 文件列表将通过JavaScript动态加载 -->
                    <div class="loading">加载中...</div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">文件内容</div>
                <div id="fileContent">
                    <div class="info">请先选择一个文件</div>
                </div>
            </div>
        </div>
        
        <!-- 数据编辑标签内容 -->
        <div class="tab-content" id="edit-tab">
            <div class="section">
                <div class="section-title">选择要编辑的文件</div>
                <div class="file-list" id="editFileList">
                    <!-- 文件列表将通过JavaScript动态加载 -->
                    <div class="loading">加载中...</div>
                </div>
            </div>
            
            <div class="section">
                <div class="form-group">
                    <label for="module-select">选择模块:</label>
                    <select id="module-select" class="form-control">
                        <option value="">请选择模块</option>
                    </select>
                </div>
                
                <div id="module-editor"></div>
                
                <div class="actions">
                    <button id="save-btn" class="btn btn-success">保存数据</button>
                    <button id="reset-btn" class="btn">重置</button>
                </div>
            </div>
        </div>
        
        <!-- 创建文件标签内容 -->
        <div class="tab-content" id="create-tab">
            <div class="section">
                <div class="form-group">
                    <label for="new-file-name">文件名 (不含扩展名):</label>
                    <input type="text" id="new-file-name" class="form-control" placeholder="例如: xzfb">
                </div>
                
                <div class="form-group">
                    <label for="new-file-title">文件标题:</label>
                    <input type="text" id="new-file-title" class="form-control" placeholder="例如: 乡镇分布">
                </div>
                
                <div class="form-group">
                    <label for="new-file-objname">对象名称:</label>
                    <input type="text" id="new-file-objname" class="form-control" placeholder="例如: xzfb">
                </div>
                
                <h3>模块定义</h3>
                <div id="modules-container">
                    <div class="module-editor">
                        <div class="field-row">
                            <input type="text" class="module-key" placeholder="模块键名 (例如: sqxz)">
                            <input type="text" class="module-name" placeholder="模块名称 (例如: 社区乡镇)">
                            <input type="text" class="module-objname" placeholder="模块对象名 (例如: sqxz)">
                            <button class="remove-btn remove-module">删除</button>
                        </div>
                        <h4>数据项</h4>
                        <div class="items-container">
                            <div class="item-editor">
                                <div class="field-row">
                                    <input type="text" class="item-key" placeholder="数据项键名 (例如: tdz)">
                                    <input type="text" class="item-name" placeholder="数据项名称 (例如: 妥甸镇)">
                                    <input type="text" class="item-objname" placeholder="数据项对象名 (例如: tdz)">
                                    <input type="text" class="item-value" placeholder="值 (可选)">
                                    <input type="text" class="item-rate" placeholder="比率 (可选)">
                                    <button class="remove-btn remove-item">删除</button>
                                </div>
                                <div class="custom-fields-container">
                                    <h5>自定义字段</h5>
                                    <div class="custom-fields-list"></div>
                                    <button class="add-btn add-custom-field">添加自定义字段</button>
                                </div>
                            </div>
                        </div>
                        <button class="add-btn add-item">添加数据项</button>
                    </div>
                </div>
                
                <button class="add-btn add-module">添加模块</button>
                <br><br>
                <div class="actions">
                    <button id="preview-btn" class="btn btn-info">预览JSON</button>
                    <button id="create-file-btn" class="btn btn-success">创建文件</button>
                </div>
                
                <div id="preview-container" style="display: none;">
                    <h3>JSON预览</h3>
                    <div id="json-preview" class="json-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentFiles = [];
        let currentData = null;
        let currentEditingFile = null;
        let currentViewFile = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化标签切换
            initTabs();
            
            // 加载文件列表
            loadFileLists();
            
            // 绑定事件
            bindEvents();
            
            // 初始化创建文件表单事件
            initCreateFileForm();
        });
        
        // 初始化标签切换
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有激活状态
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // 激活当前标签
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        // 加载文件列表
        function loadFileLists() {
            fetch('/api/json-files')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentFiles = data.files;
                        renderFileLists();
                    } else {
                        showError('获取文件列表失败: ' + data.message);
                    }
                })
                .catch(error => {
                    showError('获取文件列表出错: ' + error.message);
                });
        }
        
        // 渲染文件列表
        function renderFileLists() {
            const fileListContainer = document.getElementById('fileList');
            const editFileListContainer = document.getElementById('editFileList');
            
            // 清空容器
            fileListContainer.innerHTML = '';
            editFileListContainer.innerHTML = '';
            
            // 添加文件项
            currentFiles.forEach(file => {
                // 查看标签的文件项
                const fileItemView = document.createElement('div');
                fileItemView.className = 'file-item';
                if (file === currentViewFile) {
                    fileItemView.classList.add('active');
                }
                fileItemView.textContent = file;
                fileItemView.addEventListener('click', () => {
                    currentViewFile = file;
                    renderFileLists(); // 重新渲染以更新选中状态
                    loadFileContent(file);
                });
                
                // 编辑标签的文件项
                const fileItemEdit = document.createElement('div');
                fileItemEdit.className = 'file-item';
                if (file === currentEditingFile) {
                    fileItemEdit.classList.add('active');
                }
                fileItemEdit.textContent = file;
                fileItemEdit.addEventListener('click', () => {
                    currentEditingFile = file;
                    renderFileLists(); // 重新渲染以更新选中状态
                    loadEditFileContent(file);
                });
                
                fileListContainer.appendChild(fileItemView);
                editFileListContainer.appendChild(fileItemEdit);
            });
        }
        
        // 加载文件内容用于查看
        function loadFileContent(filename) {
            fetch(`/api/read-json-file?filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentData = data.data;
                        renderFileContent(filename, data.data);
                    } else {
                        showError('读取文件失败: ' + data.message);
                    }
                })
                .catch(error => {
                    showError('读取文件出错: ' + error.message);
                });
        }
        
        // 渲染文件内容用于查看（使用multiview.html的样式）
        function renderFileContent(filename, data) {
            const container = document.getElementById('fileContent');
            container.innerHTML = '';
            
            // 显示主标题
            const title = document.createElement('h2');
            title.textContent = data.name;
            container.appendChild(title);
            
            // 遍历各个数据模块，保持原有顺序
            for (const key in data.data) {
                const module = data.data[key];
                
                const section = document.createElement('div');
                section.className = 'section';
                
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'section-title';
                sectionTitle.textContent = module.name;
                section.appendChild(sectionTitle);
                
                // 特殊处理案件占比模块(ajzb)
                if (key === 'ajzb') {
                    // 处理案件占比模块的直接数据项（民事案件、刑事案件、其他案件）
                    for (const itemKey in module.data) {
                        // 跳过table字段，稍后单独处理
                        if (itemKey !== 'table') {
                            const item = module.data[itemKey];
                            
                            // 显示单个值的项目
                            const dataItem = document.createElement('div');
                            dataItem.className = 'data-item';
                            
                            const nameLabel = document.createElement('span');
                            nameLabel.textContent = item.name;
                            
                            const valueLabel = document.createElement('span');
                            if (item.value !== undefined) {
                                valueLabel.textContent = item.value;
                                if (item.rate) {
                                    valueLabel.textContent += ` (${item.rate})`;
                                }
                            } else {
                                // 如果没有value字段，显示其他字段，保持顺序
                                let valueText = '';
                                const fields = Object.keys(item).filter(field => 
                                    field !== 'name' && field !== 'objName');
                                fields.forEach((field, index) => {
                                    if (index > 0) valueText += ', ';
                                    valueText += `${field}: ${item[field]}`;
                                });
                                valueLabel.textContent = valueText || '无数据';
                            }
                            
                            dataItem.appendChild(nameLabel);
                            dataItem.appendChild(valueLabel);
                            section.appendChild(dataItem);
                        }
                    }
                    
                    // 处理表格数据（月份数据）
                    if (module.data && module.data.table) {
                        const tableContainer = document.createElement('div');
                        tableContainer.className = 'table-container';
                        
                        // 为月份数据创建一个独立的展示区域
                        const monthSection = document.createElement('div');
                        monthSection.className = 'module-grid';
                        
                        // 处理月份数据（数组）
                        if (module.data.table.data && Array.isArray(module.data.table.data)) {
                            module.data.table.data.forEach((monthData, index) => {
                                // 为每个月份创建一个卡片
                                const monthCard = document.createElement('div');
                                monthCard.className = 'module-card';
                                
                                // 显示月份名称
                                const monthTitle = document.createElement('h4');
                                monthTitle.textContent = monthData.name || `月份${index + 1}`;
                                monthCard.appendChild(monthTitle);
                                
                                // 显示该月份的案件数据
                                if (monthData.data && typeof monthData.data === 'object') {
                                    for (const caseType in monthData.data) {
                                        const caseData = monthData.data[caseType];
                                        if (caseData && typeof caseData === 'object') {
                                            const caseItem = document.createElement('div');
                                            caseItem.className = 'data-item';
                                            
                                            const caseName = document.createElement('span');
                                            caseName.textContent = caseData.name || caseType;
                                            
                                            const caseValue = document.createElement('span');
                                            caseValue.textContent = caseData.value || '无数据';
                                            
                                            caseItem.appendChild(caseName);
                                            caseItem.appendChild(caseValue);
                                            monthCard.appendChild(caseItem);
                                        }
                                    }
                                }
                                
                                monthSection.appendChild(monthCard);
                            });
                        }
                        
                        section.appendChild(monthSection);
                    }
                } 
                // 处理其他包含表格数据的模块
                else if (module.data && module.data.table) {
                    // 表格数据（如xzfb copy.json中的列表数据）
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';
                    
                    const table = document.createElement('table');
                    table.className = 'data-table';
                    
                    // 创建表头
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    
                    // 获取字段名，保持顺序
                    if (module.data.table.data && module.data.table.data.length > 0) {
                        // 保持与xzfb copy 2.json中相同的字段顺序: name, objName, hushu, ldsl
                        const preferredOrder = ['name', 'objName', 'hushu', 'ldsl'];
                        let fields = Object.keys(module.data.table.data[0]);
                        
                        // 按照preferredOrder排序，不在列表中的字段放到最后
                        fields.sort((a, b) => {
                            const indexA = preferredOrder.indexOf(a);
                            const indexB = preferredOrder.indexOf(b);
                            
                            // 如果两个字段都在preferredOrder中，按preferredOrder排序
                            if (indexA !== -1 && indexB !== -1) {
                                return indexA - indexB;
                            }
                            
                            // 如果只有一个是preferredOrder中的字段，preferredOrder中的排在前面
                            if (indexA !== -1) {
                                return -1;
                            }
                            
                            if (indexB !== -1) {
                                return 1;
                            }
                            
                            // 如果两个都不在preferredOrder中，保持原有顺序
                            return 0;
                        });
                        
                        fields.forEach(field => {
                            const th = document.createElement('th');
                            th.textContent = field;
                            headerRow.appendChild(th);
                        });
                        
                        thead.appendChild(headerRow);
                        table.appendChild(thead);
                        
                        // 创建表体，保持数据顺序
                        const tbody = document.createElement('tbody');
                        module.data.table.data.forEach(row => {
                            const tr = document.createElement('tr');
                            fields.forEach(field => {
                                const td = document.createElement('td');
                                td.textContent = row[field] || '';
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                        
                        table.appendChild(tbody);
                    }
                    
                    tableContainer.appendChild(table);
                    section.appendChild(tableContainer);
                } else if (hasNestedDataStructure(module.data)) {
                    // 处理复杂的嵌套数据结构
                    const moduleGrid = document.createElement('div');
                    moduleGrid.className = 'module-grid';
                    
                    // 保持数据顺序
                    for (const itemKey in module.data) {
                        const item = module.data[itemKey];
                        
                        if (itemKey !== 'table' && item && typeof item === 'object') {
                            const card = document.createElement('div');
                            card.className = 'module-card';
                            
                            const cardTitle = document.createElement('div');
                            cardTitle.className = 'module-card-title';
                            cardTitle.textContent = item.name || itemKey;
                            card.appendChild(cardTitle);
                            
                            // 渲染嵌套数据
                            renderNestedData(card, item);
                            
                            moduleGrid.appendChild(card);
                        }
                    }
                    
                    section.appendChild(moduleGrid);
                } else if (module.data) {
                    // 普通数据列表，保持顺序
                    for (const itemKey in module.data) {
                        if (itemKey !== 'table') {
                            const item = module.data[itemKey];
                            
                            // 检查是否有多个值需要显示
                            const valueFields = Object.keys(item).filter(field => 
                                field !== 'name' && field !== 'objName');
                            
                            if (valueFields.length > 1) {
                                // 显示多个值的项目
                                const multiValueItem = document.createElement('div');
                                multiValueItem.className = 'multi-value-item';
                                
                                const titleDiv = document.createElement('div');
                                titleDiv.className = 'item-title';
                                titleDiv.textContent = item.name;
                                multiValueItem.appendChild(titleDiv);
                                
                                // 保持字段顺序
                                valueFields.forEach(field => {
                                    const valueDiv = document.createElement('div');
                                    const valueTitle = document.createElement('div');
                                    valueTitle.className = 'item-title';
                                    valueTitle.textContent = field;
                                    
                                    const valueContent = document.createElement('div');
                                    valueContent.className = 'item-value';
                                    valueContent.textContent = item[field];
                                    
                                    valueDiv.appendChild(valueTitle);
                                    valueDiv.appendChild(valueContent);
                                    multiValueItem.appendChild(valueDiv);
                                });
                                
                                section.appendChild(multiValueItem);
                            } else {
                                // 显示单个值的项目
                                const dataItem = document.createElement('div');
                                dataItem.className = 'data-item';
                                
                                const nameLabel = document.createElement('span');
                                nameLabel.textContent = item.name;
                                
                                const valueLabel = document.createElement('span');
                                if (item.value !== undefined) {
                                    valueLabel.textContent = item.value;
                                    if (item.rate) {
                                        valueLabel.textContent += ` (${item.rate})`;
                                    }
                                } else {
                                    // 如果没有value字段，显示其他字段，保持顺序
                                    let valueText = '';
                                    const fields = Object.keys(item).filter(field => 
                                        field !== 'name' && field !== 'objName');
                                    fields.forEach((field, index) => {
                                        if (index > 0) valueText += ', ';
                                        valueText += `${field}: ${item[field]}`;
                                    });
                                    valueLabel.textContent = valueText || '无数据';
                                }
                                
                                dataItem.appendChild(nameLabel);
                                dataItem.appendChild(valueLabel);
                                section.appendChild(dataItem);
                            }
                        }
                    }
                }
                
                container.appendChild(section);
            }
        }

        // 检查是否具有嵌套数据结构
        function hasNestedDataStructure(data) {
            if (!data || typeof data !== 'object') return false;
            
            for (const key in data) {
                const item = data[key];
                // 检查是否包含data属性，或者包含其他字段
                if (item && typeof item === 'object') {
                    // 检查是否包含data属性，或者包含其他字段
                    const otherFields = Object.keys(item).filter(k => k !== 'name' && k !== 'objName');
                    if (item.data || otherFields.length > 0) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // 渲染嵌套数据
        function renderNestedData(container, item) {
            // 渲染直接属性（除了name和objName），保持顺序
            const fields = Object.keys(item).filter(field => 
                field !== 'name' && field !== 'objName' && field !== 'data');
            fields.forEach(field => {
                const propertyItem = document.createElement('div');
                propertyItem.className = 'property-item';
                
                const label = document.createElement('span');
                label.className = 'property-label';
                label.textContent = field;
                
                const value = document.createElement('span');
                value.className = 'property-value';
                value.textContent = item[field];
                
                propertyItem.appendChild(label);
                propertyItem.appendChild(value);
                container.appendChild(propertyItem);
            });
            
            // 渲染嵌套的data数据
            if (item.data && typeof item.data === 'object') {
                if (!Array.isArray(item.data)) {
                    // 对象类型嵌套数据，保持顺序
                    for (const subKey in item.data) {
                        const subItem = item.data[subKey];
                        if (subItem && typeof subItem === 'object') {
                            const nestedContainer = document.createElement('div');
                            nestedContainer.className = 'nested-container';
                            
                            const nestedTitle = document.createElement('div');
                            nestedTitle.className = 'nested-title';
                            nestedTitle.textContent = subItem.name || subKey;
                            nestedContainer.appendChild(nestedTitle);
                            
                            // 检查是否有嵌套的data字段（如智能装备资源）
                            if (subItem.data && typeof subItem.data === 'object' && !Array.isArray(subItem.data)) {
                                // 处理智能装备资源的子数据（在线、离线、故障等）
                                for (const dataKey in subItem.data) {
                                    const dataItem = subItem.data[dataKey];
                                    if (dataItem && typeof dataItem === 'object') {
                                        const dataContainer = document.createElement('div');
                                        dataContainer.className = 'property-item';
                                        
                                        const dataLabel = document.createElement('span');
                                        dataLabel.className = 'property-label';
                                        dataLabel.textContent = dataItem.name || dataKey;
                                        
                                        const dataValue = document.createElement('span');
                                        dataValue.className = 'property-value';
                                        dataValue.textContent = dataItem.value || '无数据';
                                        
                                        dataContainer.appendChild(dataLabel);
                                        dataContainer.appendChild(dataValue);
                                        nestedContainer.appendChild(dataContainer);
                                    }
                                }
                            } else {
                                // 递归渲染子项
                                renderNestedData(nestedContainer, subItem);
                            }
                            
                            container.appendChild(nestedContainer);
                        }
                    }
                } else {
                    // 数组类型嵌套数据（如案件占比中的月份数据）
                    const nestedContainer = document.createElement('div');
                    nestedContainer.className = 'nested-container';
                    
                    item.data.forEach((arrayItem, index) => {
                        if (typeof arrayItem === 'object' && arrayItem !== null) {
                            // 为每个月份创建一个容器
                            const monthContainer = document.createElement('div');
                            monthContainer.className = 'nested-container';
                            
                            // 显示月份名称
                            const monthTitle = document.createElement('div');
                            monthTitle.className = 'nested-title';
                            monthTitle.textContent = arrayItem.name || `数据项 ${index + 1}`;
                            monthContainer.appendChild(monthTitle);
                            
                            // 处理月份中的案件数据
                            if (arrayItem.data && typeof arrayItem.data === 'object') {
                                for (const caseType in arrayItem.data) {
                                    const caseItem = arrayItem.data[caseType];
                                    if (caseItem && typeof caseItem === 'object') {
                                        // 为每种案件类型创建显示项
                                        const caseContainer = document.createElement('div');
                                        caseContainer.className = 'property-item';
                                        
                                        const caseLabel = document.createElement('span');
                                        caseLabel.className = 'property-label';
                                        caseLabel.textContent = caseItem.name || caseType;
                                        
                                        const caseValue = document.createElement('span');
                                        caseValue.className = 'property-value';
                                        // 显示案件的值
                                        caseValue.textContent = caseItem.value || '无数据';
                                        
                                        caseContainer.appendChild(caseLabel);
                                        caseContainer.appendChild(caseValue);
                                        monthContainer.appendChild(caseContainer);
                                    }
                                }
                            }
                            
                            nestedContainer.appendChild(monthContainer);
                        }
                    });
                    
                    container.appendChild(nestedContainer);
                }
            }
        }
        
        // 加载文件内容用于编辑
        function loadEditFileContent(filename) {
            fetch(`/api/read-json-file?filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentData = JSON.parse(JSON.stringify(data.data)); // 深拷贝
                        populateModuleSelect(data.data);
                        document.getElementById('module-select').value = '';
                        document.getElementById('module-editor').innerHTML = '';
                        document.getElementById('save-btn').style.display = 'inline-block';
                    } else {
                        showError('读取文件失败: ' + data.message);
                    }
                })
                .catch(error => {
                    showError('读取文件出错: ' + error.message);
                });
        }
        
        // 填充模块选择下拉框
        function populateModuleSelect(data) {
            const select = document.getElementById('module-select');
            select.innerHTML = '<option value="">请选择模块</option>';
            
            if (!data || !data.data) return;
            
            // 保持模块顺序
            for (const key in data.data) {
                const module = data.data[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = module.name || key;
                select.appendChild(option);
            }
        }
        
        // 显示模块编辑器
        function showModuleEditor() {
            const moduleId = document.getElementById('module-select').value;
            const editorContainer = document.getElementById('module-editor');
            editorContainer.innerHTML = '';
            
            if (!moduleId || !currentData || !currentData.data[moduleId]) return;
            
            const module = currentData.data[moduleId];
            const form = document.createElement('div');
            form.className = 'module-form';
            
            const title = document.createElement('h3');
            title.textContent = `${module.name || moduleId} - 数据编辑`;
            form.appendChild(title);
            
            // 添加模块级别的编辑字段（允许编辑模块的name和objName）
            const moduleFieldsContainer = document.createElement('div');
            moduleFieldsContainer.className = 'form-group';
            
            // 编辑模块名称
            const moduleNameLabel = document.createElement('label');
            moduleNameLabel.textContent = '模块名称 (name)';
            const moduleNameInput = document.createElement('input');
            moduleNameInput.type = 'text';
            moduleNameInput.className = 'form-control';
            moduleNameInput.value = module.name || '';
            moduleNameInput.dataset.module = moduleId;
            moduleNameInput.dataset.field = 'name';
            moduleNameLabel.setAttribute('for', `module-${moduleId}-name`);
            moduleNameInput.id = `module-${moduleId}-name`;
            
            // 编辑模块对象名称
            const moduleObjNameLabel = document.createElement('label');
            moduleObjNameLabel.textContent = '模块对象名称 (objName)';
            const moduleObjNameInput = document.createElement('input');
            moduleObjNameInput.type = 'text';
            moduleObjNameInput.className = 'form-control';
            moduleObjNameInput.value = module.objName || '';
            moduleObjNameInput.dataset.module = moduleId;
            moduleObjNameInput.dataset.field = 'objName';
            moduleObjNameLabel.setAttribute('for', `module-${moduleId}-objName`);
            moduleObjNameInput.id = `module-${moduleId}-objName`;
            
            moduleFieldsContainer.appendChild(moduleNameLabel);
            moduleFieldsContainer.appendChild(moduleNameInput);
            moduleFieldsContainer.appendChild(moduleObjNameLabel);
            moduleFieldsContainer.appendChild(moduleObjNameInput);
            
            form.appendChild(moduleFieldsContainer);
            
            // 特殊处理案件占比模块(ajzb)
            if (moduleId === 'ajzb') {
                // 处理普通数据项（民事案件、刑事案件、其他案件）
                for (const itemKey in module.data) {
                    if (itemKey !== 'table') {
                        const item = module.data[itemKey];
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'form-group';
                        itemContainer.style.border = '1px solid #ddd';
                        itemContainer.style.padding = '10px';
                        itemContainer.style.marginBottom = '10px';
                        itemContainer.style.borderRadius = '4px';
                        
                        const itemTitle = document.createElement('h4');
                        itemTitle.textContent = `${item.name || itemKey} (${itemKey})`;
                        itemContainer.appendChild(itemTitle);
                        
                        // 保持字段顺序
                        const fields = ['name', 'objName', 'value']; // 固定顺序
                        fields.forEach(field => {
                            if (item.hasOwnProperty(field)) {
                                const fieldContainer = document.createElement('div');
                                fieldContainer.className = 'form-group';
                                
                                const fieldLabel = document.createElement('label');
                                fieldLabel.textContent = field;
                                fieldLabel.setAttribute('for', `${moduleId}-${itemKey}-${field}`);
                                fieldContainer.appendChild(fieldLabel);
                                
                                const fieldInput = document.createElement('input');
                                fieldInput.type = 'text';
                                fieldInput.id = `${moduleId}-${itemKey}-${field}`;
                                fieldInput.className = 'form-control';
                                fieldInput.value = item[field] || '';
                                fieldInput.dataset.module = moduleId;
                                fieldInput.dataset.item = itemKey;
                                fieldInput.dataset.field = field;
                                fieldContainer.appendChild(fieldInput);
                                
                                itemContainer.appendChild(fieldContainer);
                            }
                        });
                        
                        form.appendChild(itemContainer);
                    }
                }
                
                // 处理表格数据
                if (module.data && module.data.table && Array.isArray(module.data.table.data)) {
                    const tableData = module.data.table.data;
                    
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'form-group';
                    
                    const tableTitle = document.createElement('h4');
                    tableTitle.textContent = '表格数据编辑';
                    tableContainer.appendChild(tableTitle);
                    
                    // 为每个表格行创建编辑字段，保持顺序
                    tableData.forEach((row, index) => {
                        const rowContainer = document.createElement('div');
                        rowContainer.className = 'form-group';
                        rowContainer.style.border = '1px solid #ddd';
                        rowContainer.style.padding = '10px';
                        rowContainer.style.marginBottom = '10px';
                        rowContainer.style.borderRadius = '4px';
                        
                        const rowTitle = document.createElement('h5');
                        rowTitle.textContent = `数据项 ${index + 1} - ${row.name}`;
                        rowContainer.appendChild(rowTitle);
                        
                        // 编辑月份名称
                        const nameFieldContainer = document.createElement('div');
                        nameFieldContainer.className = 'form-group';
                        
                        const nameLabel = document.createElement('label');
                        nameLabel.textContent = 'name';
                        nameLabel.setAttribute('for', `${moduleId}-table-${index}-name`);
                        nameFieldContainer.appendChild(nameLabel);
                        
                        const nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.id = `${moduleId}-table-${index}-name`;
                        nameInput.className = 'form-control';
                        nameInput.value = row.name || '';
                        nameInput.dataset.module = moduleId;
                        nameInput.dataset.index = index;
                        nameInput.dataset.field = 'name';
                        nameInput.dataset.type = 'table';
                        nameFieldContainer.appendChild(nameInput);
                        
                        rowContainer.appendChild(nameFieldContainer);
                        
                        // 处理data中的案件数据
                        if (row.data) {
                            for (const dataKey in row.data) {
                                const dataItem = row.data[dataKey];
                                const dataItemContainer = document.createElement('div');
                                dataItemContainer.className = 'form-group';
                                dataItemContainer.style.border = '1px dashed #ccc';
                                dataItemContainer.style.padding = '8px';
                                dataItemContainer.style.margin = '5px 0';
                                dataItemContainer.style.borderRadius = '3px';
                                
                                const dataItemTitle = document.createElement('h6');
                                dataItemTitle.textContent = `${dataItem.name || dataKey} (${dataKey})`;
                                dataItemContainer.appendChild(dataItemTitle);
                                
                                // 保持字段顺序
                                const fields = ['name', 'objName', 'value']; // 固定顺序
                                fields.forEach(field => {
                                    if (dataItem.hasOwnProperty(field)) {
                                        const fieldContainer = document.createElement('div');
                                        fieldContainer.className = 'form-group';
                                        
                                        const fieldLabel = document.createElement('label');
                                        fieldLabel.textContent = field;
                                        fieldLabel.setAttribute('for', `${moduleId}-table-${index}-${dataKey}-${field}`);
                                        fieldContainer.appendChild(fieldLabel);
                                        
                                        const fieldInput = document.createElement('input');
                                        fieldInput.type = 'text';
                                        fieldInput.id = `${moduleId}-table-${index}-${dataKey}-${field}`;
                                        fieldInput.className = 'form-control';
                                        fieldInput.value = dataItem[field] || '';
                                        fieldInput.dataset.module = moduleId;
                                        fieldInput.dataset.index = index;
                                        fieldInput.dataset.datakey = dataKey;
                                        fieldInput.dataset.field = field;
                                        fieldInput.dataset.type = 'table-data';
                                        fieldContainer.appendChild(fieldInput);
                                        
                                        dataItemContainer.appendChild(fieldContainer);
                                    }
                                });
                                
                                rowContainer.appendChild(dataItemContainer);
                            }
                        }
                        
                        tableContainer.appendChild(rowContainer);
                    });
                    
                    form.appendChild(tableContainer);
                }
            }
            // 特殊处理智能装备资源模块(znzbzy)
            else if (moduleId === 'znzbzy') {
                // 处理智能装备资源数据项（智能监控、无人机等）
                for (const itemKey in module.data) {
                    const item = module.data[itemKey];
                    const itemContainer = document.createElement('div');
                    itemContainer.className = 'form-group';
                    itemContainer.style.border = '1px solid #ddd';
                    itemContainer.style.padding = '10px';
                    itemContainer.style.marginBottom = '10px';
                    itemContainer.style.borderRadius = '4px';
                    
                    const itemTitle = document.createElement('h4');
                    itemTitle.textContent = `${item.name || itemKey} (${itemKey})`;
                    itemContainer.appendChild(itemTitle);
                    
                    // 编辑基础字段
                    const basicFields = ['name', 'objName', 'value']; // 固定顺序
                    basicFields.forEach(field => {
                        if (item.hasOwnProperty(field)) {
                            const fieldContainer = document.createElement('div');
                            fieldContainer.className = 'form-group';
                            
                            const fieldLabel = document.createElement('label');
                            fieldLabel.textContent = field;
                            fieldLabel.setAttribute('for', `${moduleId}-${itemKey}-${field}`);
                            fieldContainer.appendChild(fieldLabel);
                            
                            const fieldInput = document.createElement('input');
                            fieldInput.type = 'text';
                            fieldInput.id = `${moduleId}-${itemKey}-${field}`;
                            fieldInput.className = 'form-control';
                            fieldInput.value = item[field] || '';
                            fieldInput.dataset.module = moduleId;
                            fieldInput.dataset.item = itemKey;
                            fieldInput.dataset.field = field;
                            fieldContainer.appendChild(fieldInput);
                            
                            itemContainer.appendChild(fieldContainer);
                        }
                    });
                    
                    // 处理嵌套的data数据（在线、离线、故障等）
                    if (item.data && typeof item.data === 'object' && !Array.isArray(item.data)) {
                        const dataContainer = document.createElement('div');
                        dataContainer.className = 'form-group';
                        dataContainer.style.border = '1px dashed #ccc';
                        dataContainer.style.padding = '8px';
                        dataContainer.style.margin = '5px 0';
                        dataContainer.style.borderRadius = '3px';
                        
                        const dataTitle = document.createElement('h5');
                        dataTitle.textContent = '状态数据';
                        dataContainer.appendChild(dataTitle);
                        
                        for (const dataKey in item.data) {
                            const dataItem = item.data[dataKey];
                            const dataItemContainer = document.createElement('div');
                            dataItemContainer.className = 'form-group';
                            
                            const dataItemTitle = document.createElement('h6');
                            dataItemTitle.textContent = `${dataItem.name || dataKey} (${dataKey})`;
                            dataItemContainer.appendChild(dataItemTitle);
                            
                            // 编辑嵌套数据的字段
                            const nestedFields = ['name', 'objName', 'value']; // 固定顺序
                            nestedFields.forEach(field => {
                                if (dataItem.hasOwnProperty(field)) {
                                    const fieldContainer = document.createElement('div');
                                    fieldContainer.className = 'form-group';
                                    
                                    const fieldLabel = document.createElement('label');
                                    fieldLabel.textContent = field;
                                    fieldLabel.setAttribute('for', `${moduleId}-${itemKey}-data-${dataKey}-${field}`);
                                    fieldContainer.appendChild(fieldLabel);
                                    
                                    const fieldInput = document.createElement('input');
                                    fieldInput.type = 'text';
                                    fieldInput.id = `${moduleId}-${itemKey}-data-${dataKey}-${field}`;
                                    fieldInput.className = 'form-control';
                                    fieldInput.value = dataItem[field] || '';
                                    fieldInput.dataset.module = moduleId;
                                    fieldInput.dataset.item = itemKey;
                                    fieldInput.dataset.datakey = dataKey;
                                    fieldInput.dataset.field = field;
                                    fieldInput.dataset.type = 'nested-data';
                                    fieldContainer.appendChild(fieldInput);
                                    
                                    dataItemContainer.appendChild(fieldContainer);
                                }
                            });
                            
                            dataContainer.appendChild(dataItemContainer);
                        }
                        
                        itemContainer.appendChild(dataContainer);
                    }
                    
                    form.appendChild(itemContainer);
                }
            }
            // 处理其他模块
            else if (module.data && module.data.table && Array.isArray(module.data.table.data)) {
                // 处理表格数据结构（如xzfb copy.json中的乡镇列表）
                const tableData = module.data.table.data;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'form-group';
                
                const tableTitle = document.createElement('h4');
                tableTitle.textContent = '表格数据编辑';
                tableContainer.appendChild(tableTitle);
                
                // 为每个表格行创建编辑字段，保持顺序
                tableData.forEach((row, index) => {
                    const rowContainer = document.createElement('div');
                    rowContainer.className = 'form-group';
                    rowContainer.style.border = '1px solid #ddd';
                    rowContainer.style.padding = '10px';
                    rowContainer.style.marginBottom = '10px';
                    rowContainer.style.borderRadius = '4px';
                    
                    const rowTitle = document.createElement('h5');
                    rowTitle.textContent = `数据项 ${index + 1} - ${row.name || ''}`;
                    rowContainer.appendChild(rowTitle);
                    
                    // 保持字段顺序，按照xzfb copy 2.json中的顺序: name, objName, hushu, ldsl
                    const preferredOrder = ['name', 'objName', 'hushu', 'ldsl'];
                    let fields = Object.keys(row);
                    
                    // 按照preferredOrder排序，不在列表中的字段放到最后
                    fields.sort((a, b) => {
                        const indexA = preferredOrder.indexOf(a);
                        const indexB = preferredOrder.indexOf(b);
                        
                        // 如果两个字段都在preferredOrder中，按preferredOrder排序
                        if (indexA !== -1 && indexB !== -1) {
                            return indexA - indexB;
                        }
                        
                        // 如果只有一个是preferredOrder中的字段，preferredOrder中的排在前面
                        if (indexA !== -1) {
                            return -1;
                        }
                        
                        if (indexB !== -1) {
                            return 1;
                        }
                        
                        // 如果两个都不在preferredOrder中，保持原有顺序
                        return 0;
                    });
                    
                    fields.forEach(field => {
                        const fieldContainer = document.createElement('div');
                        fieldContainer.className = 'form-group';
                        
                        const fieldLabel = document.createElement('label');
                        fieldLabel.textContent = field;
                        fieldLabel.setAttribute('for', `${moduleId}-table-${index}-${field}`);
                        fieldContainer.appendChild(fieldLabel);
                        
                        const fieldInput = document.createElement('input');
                        fieldInput.type = 'text';
                        fieldInput.id = `${moduleId}-table-${index}-${field}`;
                        fieldInput.className = 'form-control';
                        fieldInput.value = row[field] || '';
                        fieldInput.dataset.module = moduleId;
                        fieldInput.dataset.index = index;
                        fieldInput.dataset.field = field;
                        fieldInput.dataset.type = 'table';
                        fieldContainer.appendChild(fieldInput);
                        
                        rowContainer.appendChild(fieldContainer);
                    });
                    
                    tableContainer.appendChild(rowContainer);
                });
                
                form.appendChild(tableContainer);
            } else {
                // 处理普通数据结构，保持顺序
                for (const itemKey in module.data) {
                    if (itemKey !== 'table') {
                        const item = module.data[itemKey];
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'form-group';
                        itemContainer.style.border = '1px solid #ddd';
                        itemContainer.style.padding = '10px';
                        itemContainer.style.marginBottom = '10px';
                        itemContainer.style.borderRadius = '4px';
                        
                        const itemTitle = document.createElement('h4');
                        itemTitle.textContent = `${item.name || itemKey} (${itemKey})`;
                        itemContainer.appendChild(itemTitle);
                        
                        // 保持字段顺序
                        const fields = Object.keys(item);
                        fields.forEach(field => {
                            const fieldContainer = document.createElement('div');
                            fieldContainer.className = 'form-group';
                            
                            const fieldLabel = document.createElement('label');
                            fieldLabel.textContent = field;
                            fieldLabel.setAttribute('for', `${moduleId}-${itemKey}-${field}`);
                            fieldContainer.appendChild(fieldLabel);
                            
                            const fieldInput = document.createElement('input');
                            fieldInput.type = 'text';
                            fieldInput.id = `${moduleId}-${itemKey}-${field}`;
                            fieldInput.className = 'form-control';
                            fieldInput.value = item[field] || '';
                            fieldInput.dataset.module = moduleId;
                            fieldInput.dataset.item = itemKey;
                            fieldInput.dataset.field = field;
                            fieldContainer.appendChild(fieldInput);
                            
                            itemContainer.appendChild(fieldContainer);
                        });
                        
                        form.appendChild(itemContainer);
                    }
                }
            }
            
            editorContainer.appendChild(form);
        }
        
        // 初始化创建文件表单事件
        function initCreateFileForm() {
            // 绑定第一个模块的删除事件
            document.querySelector('.remove-module').addEventListener('click', function() {
                if (document.querySelectorAll('.module-editor').length > 1) {
                    this.closest('.module-editor').remove();
                } else {
                    alert('至少需要保留一个模块');
                }
            });
            
            // 绑定第一个数据项的删除事件
            document.querySelector('.remove-item').addEventListener('click', function() {
                if (this.closest('.items-container').querySelectorAll('.item-editor').length > 1) {
                    this.closest('.item-editor').remove();
                } else {
                    alert('每个模块至少需要一个数据项');
                }
            });
            
            // 绑定第一个添加数据项事件
            document.querySelector('.add-item').addEventListener('click', function() {
                addItem(this.closest('.module-editor'));
            });
            
            // 绑定第一个添加自定义字段事件
            document.querySelector('.add-custom-field').addEventListener('click', function() {
                addCustomField(this.closest('.item-editor'));
            });
            
            // 绑定添加模块事件
            document.querySelector('.add-module').addEventListener('click', addModule);
            
            // 绑定创建文件按钮事件
            document.getElementById('create-file-btn').addEventListener('click', createNewFile);
            
            // 绑定预览按钮事件
            document.getElementById('preview-btn').addEventListener('click', previewJson);
        }
        
        // 添加模块
        function addModule() {
            const modulesContainer = document.getElementById('modules-container');
            const moduleEditor = document.createElement('div');
            moduleEditor.className = 'module-editor';
            
            moduleEditor.innerHTML = `
                <div class="field-row">
                    <input type="text" class="module-key" placeholder="模块键名 (例如: sqxz)">
                    <input type="text" class="module-name" placeholder="模块名称 (例如: 社区乡镇)">
                    <input type="text" class="module-objname" placeholder="模块对象名 (例如: sqxz)">
                    <button class="remove-btn remove-module">删除</button>
                </div>
                <h4>数据项</h4>
                <div class="items-container">
                    <div class="item-editor">
                        <div class="field-row">
                            <input type="text" class="item-key" placeholder="数据项键名 (例如: tdz)">
                            <input type="text" class="item-name" placeholder="数据项名称 (例如: 妥甸镇)">
                            <input type="text" class="item-objname" placeholder="数据项对象名 (例如: tdz)">
                            <input type="text" class="item-value" placeholder="值 (可选)">
                            <input type="text" class="item-rate" placeholder="比率 (可选)">
                            <button class="remove-btn remove-item">删除</button>
                        </div>
                        <div class="custom-fields-container">
                            <h5>自定义字段</h5>
                            <div class="custom-fields-list"></div>
                            <button class="add-btn add-custom-field">添加自定义字段</button>
                        </div>
                    </div>
                </div>
                <button class="add-btn add-item">添加数据项</button>
            `;
            
            modulesContainer.appendChild(moduleEditor);
            
            // 绑定新模块的事件
            moduleEditor.querySelector('.remove-module').addEventListener('click', function() {
                if (document.querySelectorAll('.module-editor').length > 1) {
                    moduleEditor.remove();
                } else {
                    alert('至少需要保留一个模块');
                }
            });
            
            moduleEditor.querySelector('.add-item').addEventListener('click', function() {
                addItem(moduleEditor);
            });
            
            // 绑定新数据项的删除事件
            moduleEditor.querySelector('.remove-item').addEventListener('click', function() {
                if (moduleEditor.querySelectorAll('.item-editor').length > 1) {
                    this.closest('.item-editor').remove();
                } else {
                    alert('每个模块至少需要一个数据项');
                }
            });
            
            // 绑定添加自定义字段事件
            moduleEditor.querySelector('.add-custom-field').addEventListener('click', function() {
                addCustomField(this.closest('.item-editor'));
            });
        }
        
        // 添加数据项
        function addItem(moduleEditor) {
            const itemsContainer = moduleEditor.querySelector('.items-container');
            const itemEditor = document.createElement('div');
            itemEditor.className = 'item-editor';
            
            itemEditor.innerHTML = `
                <div class="field-row">
                    <input type="text" class="item-key" placeholder="数据项键名 (例如: tdz)">
                    <input type="text" class="item-name" placeholder="数据项名称 (例如: 妥甸镇)">
                    <input type="text" class="item-objname" placeholder="数据项对象名 (例如: tdz)">
                    <input type="text" class="item-value" placeholder="值 (可选)">
                    <input type="text" class="item-rate" placeholder="比率 (可选)">
                    <button class="remove-btn remove-item">删除</button>
                </div>
                <div class="custom-fields-container">
                    <h5>自定义字段</h5>
                    <div class="custom-fields-list"></div>
                    <button class="add-btn add-custom-field">添加自定义字段</button>
                </div>
            `;
            
            itemsContainer.appendChild(itemEditor);
            
            // 绑定新数据项的删除事件
            itemEditor.querySelector('.remove-item').addEventListener('click', function() {
                if (itemsContainer.querySelectorAll('.item-editor').length > 1) {
                    itemEditor.remove();
                } else {
                    alert('每个模块至少需要一个数据项');
                }
            });
            
            // 绑定添加自定义字段事件
            itemEditor.querySelector('.add-custom-field').addEventListener('click', function() {
                addCustomField(itemEditor);
            });
        }
        
        // 添加自定义字段
        function addCustomField(itemEditor) {
            const customFieldsList = itemEditor.querySelector('.custom-fields-list');
            const customField = document.createElement('div');
            customField.className = 'custom-field';
            
            customField.innerHTML = `
                <input type="text" class="custom-field-name" placeholder="字段名">
                <input type="text" class="custom-field-input" placeholder="字段值">
                <button class="remove-btn remove-custom-field">删除</button>
            `;
            
            customFieldsList.appendChild(customField);
            
            // 绑定删除自定义字段事件
            customField.querySelector('.remove-custom-field').addEventListener('click', function() {
                customField.remove();
            });
            
            // 绑定字段名变化事件
            const fieldNameInput = customField.querySelector('.custom-field-name');
            const fieldValueInput = customField.querySelector('.custom-field-input');
            
            fieldNameInput.addEventListener('input', function() {
                fieldValueInput.dataset.fieldName = this.value;
            });
        }
        
        // 构建JSON数据结构，确保格式与xzfb copy 2.json一致，保持正确的字段顺序
        function buildJsonData() {
            const fileTitle = document.getElementById('new-file-title').value.trim();
            const fileObjName = document.getElementById('new-file-objname').value.trim();
            
            if (!fileTitle || !fileObjName) {
                throw new Error('请填写文件标题和对象名称');
            }
            
            // 按照正确的顺序创建JSON对象
            const jsonData = {};
            jsonData.name = fileTitle;
            jsonData.objName = fileObjName;
            jsonData.data = {};
            
            const modules = document.querySelectorAll('.module-editor');
            
            if (modules.length === 0) {
                throw new Error('至少需要一个模块');
            }
            
            modules.forEach((module, moduleIndex) => {
                const moduleKey = module.querySelector('.module-key').value.trim();
                const moduleName = module.querySelector('.module-name').value.trim();
                const moduleObjName = module.querySelector('.module-objname').value.trim();
                
                // 允许模块字段为空
                if (!moduleKey) {
                    throw new Error(`第${moduleIndex + 1}个模块的键名不能为空`);
                }
                
                // 按照正确的顺序创建模块对象
                jsonData.data[moduleKey] = {};
                jsonData.data[moduleKey].name = moduleName || '';
                jsonData.data[moduleKey].objName = moduleObjName || '';
                jsonData.data[moduleKey].data = {};
                
                const items = module.querySelectorAll('.item-editor');
                if (items.length === 0) {
                    throw new Error(`模块"${moduleName}"中至少需要一个数据项`);
                }
                
                items.forEach((item, itemIndex) => {
                    const itemKey = item.querySelector('.item-key').value.trim();
                    const itemName = item.querySelector('.item-name').value.trim();
                    const itemObjName = item.querySelector('.item-objname').value.trim();
                    const itemValue = item.querySelector('.item-value').value.trim();
                    const itemRate = item.querySelector('.item-rate').value.trim();
                    
                    // 允许数据项字段为空
                    if (!itemKey) {
                        throw new Error(`模块"${moduleName}"中第${itemIndex + 1}个数据项的键名不能为空`);
                    }
                    
                    // 按照正确的顺序创建数据项对象
                    jsonData.data[moduleKey].data[itemKey] = {};
                    jsonData.data[moduleKey].data[itemKey].name = itemName || '';
                    jsonData.data[moduleKey].data[itemKey].objName = itemObjName || '';
                    
                    // 只有当值不为空时才添加字段
                    if (itemValue) {
                        jsonData.data[moduleKey].data[itemKey].value = itemValue;
                    }
                    
                    if (itemRate) {
                        jsonData.data[moduleKey].data[itemKey].rate = itemRate;
                    }
                    
                    // 添加自定义字段
                    const customFields = item.querySelectorAll('.custom-field-input');
                    customFields.forEach(field => {
                        const fieldName = field.dataset.fieldName;
                        const fieldValue = field.value.trim();
                        
                        if (fieldName && fieldValue) {
                            jsonData.data[moduleKey].data[itemKey][fieldName] = fieldValue;
                        }
                    });
                });
            });
            
            return jsonData;
        }
        
        // 预览JSON
        function previewJson() {
            try {
                const jsonData = buildJsonData();
                if (!jsonData) {
                    return; // 错误信息已在buildJsonData中显示
                }
                
                const previewContainer = document.getElementById('preview-container');
                const jsonPreview = document.getElementById('json-preview');
                
                jsonPreview.textContent = JSON.stringify(jsonData, null, 2);
                previewContainer.style.display = 'block';
            } catch (e) {
                alert('预览时出错: ' + e.message);
            }
        }
        
        // 创建新文件
        function createNewFile() {
            const fileName = document.getElementById('new-file-name').value.trim();
            const fileTitle = document.getElementById('new-file-title').value.trim();
            const fileObjName = document.getElementById('new-file-objname').value.trim();
            
            if (!fileName) {
                showError('请输入文件名');
                return;
            }
            
            if (!fileTitle) {
                showError('请输入文件标题');
                return;
            }
            
            if (!fileObjName) {
                showError('请输入对象名称');
                return;
            }
            
            const fullFileName = fileName.endsWith('.json') ? fileName : fileName + '.json';
            
            // 构建JSON数据结构
            let jsonData;
            try {
                jsonData = buildJsonData();
            } catch (e) {
                showError('构建JSON数据时出错: ' + e.message);
                return;
            }
            
            if (!jsonData) {
                return; // 错误信息已在buildJsonData中显示
            }
            
            fetch('/api/create-json-file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: fullFileName,
                    data: jsonData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('文件创建成功');
                    // 重新加载文件列表
                    loadFileLists();
                    // 清空输入框
                    document.getElementById('new-file-name').value = '';
                    document.getElementById('new-file-title').value = '';
                    document.getElementById('new-file-objname').value = '';
                    
                    // 重置模块编辑器
                    resetModuleEditor();
                } else {
                    showError('创建文件失败: ' + data.message);
                }
            })
            .catch(error => {
                showError('创建文件出错: ' + error.message);
            });
        }
        
        // 重置模块编辑器
        function resetModuleEditor() {
            const modulesContainer = document.getElementById('modules-container');
            modulesContainer.innerHTML = `
                <div class="module-editor">
                    <div class="field-row">
                        <input type="text" class="module-key" placeholder="模块键名 (例如: sqxz)">
                        <input type="text" class="module-name" placeholder="模块名称 (例如: 社区乡镇)">
                        <input type="text" class="module-objname" placeholder="模块对象名 (例如: sqxz)">
                        <button class="remove-btn remove-module">删除</button>
                    </div>
                    <h4>数据项</h4>
                    <div class="items-container">
                        <div class="item-editor">
                            <div class="field-row">
                                <input type="text" class="item-key" placeholder="数据项键名 (例如: tdz)">
                                <input type="text" class="item-name" placeholder="数据项名称 (例如: 妥甸镇)">
                                <input type="text" class="item-objname" placeholder="数据项对象名 (例如: tdz)">
                                <input type="text" class="item-value" placeholder="值 (可选)">
                                <input type="text" class="item-rate" placeholder="比率 (可选)">
                                <button class="remove-btn remove-item">删除</button>
                            </div>
                            <div class="custom-fields-container">
                                <h5>自定义字段</h5>
                                <div class="custom-fields-list"></div>
                                <button class="add-btn add-custom-field">添加自定义字段</button>
                            </div>
                        </div>
                    </div>
                    <button class="add-btn add-item">添加数据项</button>
                </div>
            `;
            
            // 重新绑定事件
            document.querySelector('.remove-module').addEventListener('click', function() {
                if (document.querySelectorAll('.module-editor').length > 1) {
                    this.closest('.module-editor').remove();
                } else {
                    alert('至少需要保留一个模块');
                }
            });
            
            document.querySelector('.remove-item').addEventListener('click', function() {
                if (document.querySelector('.items-container').querySelectorAll('.item-editor').length > 1) {
                    this.closest('.item-editor').remove();
                } else {
                    alert('每个模块至少需要一个数据项');
                }
            });
            
            document.querySelector('.add-item').addEventListener('click', function() {
                addItem(this.closest('.module-editor'));
            });
            
            document.querySelector('.add-custom-field').addEventListener('click', function() {
                addCustomField(this.closest('.item-editor'));
            });
        }
        
        // 绑定事件
        function bindEvents() {
            // 模块选择事件
            document.getElementById('module-select').addEventListener('change', showModuleEditor);
            
            // 保存更改按钮
            document.getElementById('save-btn').addEventListener('click', saveChanges);
            
            // 重置按钮
            document.getElementById('reset-btn').addEventListener('click', resetForm);
        }
        
        // 保存更改
        function saveChanges() {
            if (!currentEditingFile || !currentData) {
                showError('没有要保存的数据');
                return;
            }
            
            // 收集表单数据并更新currentData
            const inputs = document.querySelectorAll('#module-editor input');
            let hasChanges = false;
            
            inputs.forEach(input => {
                const moduleId = input.dataset.module;
                const field = input.dataset.field;
                const value = input.value;
                
                // 处理表格数据结构中的嵌套数据（如案件占比中的月份数据）
                if (input.dataset.type === 'table-data') {
                    const index = parseInt(input.dataset.index);
                    const dataKey = input.dataset.datakey;
                    if (currentData.data[moduleId] && 
                        currentData.data[moduleId].data.table &&
                        currentData.data[moduleId].data.table.data[index] &&
                        currentData.data[moduleId].data.table.data[index].data &&
                        currentData.data[moduleId].data.table.data[index].data[dataKey]) {
                        if (currentData.data[moduleId].data.table.data[index].data[dataKey][field] !== value) {
                            currentData.data[moduleId].data.table.data[index].data[dataKey][field] = value;
                            hasChanges = true;
                        }
                    }
                }
                // 处理嵌套数据结构（如智能装备资源中的在线、离线、故障等数据）
                else if (input.dataset.type === 'nested-data') {
                    const itemKey = input.dataset.item;
                    const dataKey = input.dataset.datakey;
                    if (currentData.data[moduleId] && 
                        currentData.data[moduleId].data[itemKey] &&
                        currentData.data[moduleId].data[itemKey].data &&
                        currentData.data[moduleId].data[itemKey].data[dataKey]) {
                        if (currentData.data[moduleId].data[itemKey].data[dataKey][field] !== value) {
                            currentData.data[moduleId].data[itemKey].data[dataKey][field] = value;
                            hasChanges = true;
                        }
                    }
                }
                // 处理表格数据结构（如xzfb copy.json中的乡镇列表）
                else if (input.dataset.type === 'table') {
                    const index = parseInt(input.dataset.index);
                    if (currentData.data[moduleId] && 
                        currentData.data[moduleId].data.table &&
                        currentData.data[moduleId].data.table.data[index]) {
                        if (currentData.data[moduleId].data.table.data[index][field] !== value) {
                            currentData.data[moduleId].data.table.data[index][field] = value;
                            hasChanges = true;
                        }
                    }
                }
                // 处理模块级别的字段更新
                else if (!input.dataset.item && field) {
                    // 这是模块级别的字段更新（如name或objName）
                    if (currentData.data[moduleId]) {
                        if (currentData.data[moduleId][field] !== value) {
                            currentData.data[moduleId][field] = value;
                            hasChanges = true;
                        }
                    }
                } 
                // 处理数据项级别的字段更新
                else {
                    const itemId = input.dataset.item;
                    if (moduleId && itemId && field) {
                        if (currentData.data[moduleId] && 
                            currentData.data[moduleId].data[itemId]) {
                            if (currentData.data[moduleId].data[itemId][field] !== value) {
                                currentData.data[moduleId].data[itemId][field] = value;
                                hasChanges = true;
                            }
                        }
                    }
                }
            });
            
            if (!hasChanges) {
                showSuccess('没有检测到数据变化');
                return;
            }
            
            // 确保保存的数据保持正确的字段顺序
            const orderedData = createOrderedJsonData(currentData);
            
            fetch('/api/save-json-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: currentEditingFile,
                    data: orderedData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('文件保存成功');
                } else {
                    showError('保存文件失败: ' + data.message);
                }
            })
            .catch(error => {
                showError('保存文件出错: ' + error.message);
            });
        }
        
        // 创建保持正确字段顺序的JSON数据
        function createOrderedJsonData(data) {
            // 按照正确的顺序创建JSON对象
            const orderedData = {};
            orderedData.name = data.name;
            orderedData.objName = data.objName;
            orderedData.data = {};
            
            // 保持模块顺序
            for (const moduleKey in data.data) {
                const module = data.data[moduleKey];
                orderedData.data[moduleKey] = {};
                orderedData.data[moduleKey].name = module.name;
                orderedData.data[moduleKey].objName = module.objName;
                orderedData.data[moduleKey].data = {};
                
                // 处理模块内的数据
                if (module.data) {
                    // 特殊处理案件占比模块(ajzb)
                    if (moduleKey === 'ajzb' && module.data) {
                        // 先处理非table字段
                        for (const itemKey in module.data) {
                            if (itemKey !== 'table') {
                                const item = module.data[itemKey];
                                orderedData.data[moduleKey].data[itemKey] = {};
                                orderedData.data[moduleKey].data[itemKey].name = item.name;
                                orderedData.data[moduleKey].data[itemKey].objName = item.objName;
                                if (item.value !== undefined) {
                                    orderedData.data[moduleKey].data[itemKey].value = item.value;
                                }
                            }
                        }
                        
                        // 最后处理table字段
                        if (module.data.table) {
                            orderedData.data[moduleKey].data.table = {};
                            orderedData.data[moduleKey].data.table.name = module.data.table.name;
                            orderedData.data[moduleKey].data.table.objName = module.data.table.objName;
                            orderedData.data[moduleKey].data.table.data = [];
                            
                            // 处理table中的数据
                            if (Array.isArray(module.data.table.data)) {
                                module.data.table.data.forEach(row => {
                                    const orderedRow = {};
                                    // 保持字段顺序: name, data
                                    orderedRow.name = row.name;
                                    if (row.data) {
                                        orderedRow.data = {};
                                        // 保持data中的字段顺序
                                        for (const dataKey in row.data) {
                                            const dataItem = row.data[dataKey];
                                            orderedRow.data[dataKey] = {};
                                            orderedRow.data[dataKey].name = dataItem.name;
                                            orderedRow.data[dataKey].objName = dataItem.objName;
                                            orderedRow.data[dataKey].value = dataItem.value;
                                        }
                                    }
                                    orderedData.data[moduleKey].data.table.data.push(orderedRow);
                                });
                            }
                        }
                    } 
                    // 处理其他模块
                    else {
                        for (const itemKey in module.data) {
                            const item = module.data[itemKey];
                            orderedData.data[moduleKey].data[itemKey] = {};
                            
                            // 保持字段顺序：name, objName, 其他字段
                            orderedData.data[moduleKey].data[itemKey].name = item.name;
                            orderedData.data[moduleKey].data[itemKey].objName = item.objName;
                            
                            // 处理其他字段
                            for (const fieldKey in item) {
                                if (fieldKey !== 'name' && fieldKey !== 'objName') {
                                    orderedData.data[moduleKey].data[itemKey][fieldKey] = item[fieldKey];
                                }
                            }
                            
                            // 特殊处理table结构
                            if (itemKey === 'table' && Array.isArray(item.data)) {
                                orderedData.data[moduleKey].data[itemKey].data = [];
                                item.data.forEach(row => {
                                    const orderedRow = {};
                                    // 保持字段顺序
                                    for (const fieldKey in row) {
                                        orderedRow[fieldKey] = row[fieldKey];
                                    }
                                    orderedData.data[moduleKey].data[itemKey].data.push(orderedRow);
                                });
                            }
                        }
                    }
                }
            }
            
            return orderedData;
        }
        
        // 重置表单
        function resetForm() {
            if (confirm('确定要重置所有更改吗？')) {
                document.getElementById('module-select').value = '';
                document.getElementById('module-editor').innerHTML = '';
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            // 3秒后自动移除错误信息
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
        
        // 显示成功信息
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.cssText = 'color: green; padding: 10px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin: 10px 0;';
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            // 3秒后自动移除成功信息
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>