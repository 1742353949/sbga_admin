<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据导入管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">数据导入管理</h2>
                
                <!-- 步骤指示器 -->
                <ul class="nav nav-tabs mb-4" id="importTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                            1. 上传文件
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" disabled>
                            2. 预览数据
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping" type="button" role="tab" disabled>
                            3. 字段映射
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab" disabled>
                            4. 导入数据
                        </button>
                    </li>
                </ul>
                
                <!-- 步骤内容 -->
                <div class="tab-content" id="importTabContent">
                    <!-- 第一步：上传文件 -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">上传数据文件</h5>
                            </div>
                            <div class="card-body">
                                <form id="uploadForm">
                                    <div class="mb-3">
                                        <label for="fileInput" class="form-label">选择文件</label>
                                        <input class="form-control" type="file" id="fileInput" accept=".xls,.xlsx,.csv">
                                        <div class="form-text">支持 Excel (.xls, .xlsx) 和 CSV (.csv) 格式</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="uploadBtn">
                                        <i class="bi bi-upload"></i> 上传文件
                                    </button>
                                </form>
                                
                                <div id="uploadResult" class="mt-3" style="display:none;">
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle-fill"></i> 
                                        文件上传成功！<span id="fileName"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二步：预览数据 -->
                    <div class="tab-pane fade" id="preview" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">数据预览</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">文件信息</label>
                                    <div id="fileInfo"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">数据预览 (前10行)</label>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered" id="previewTable">
                                            <thead id="previewTableHead"></thead>
                                            <tbody id="previewTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" id="confirmPreviewBtn">
                                    <i class="bi bi-arrow-right"></i> 继续到字段映射
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第三步：字段映射 -->
                    <div class="tab-pane fade" id="mapping" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">字段映射配置</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">选择目标数据表</label>
                                            <select class="form-select" id="targetTableSelect">
                                                <option value="">请选择...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">文件列</label>
                                            <div id="fileColumnsList"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">数据库表字段</label>
                                            <div id="dbColumnsList"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">字段映射关系</label>
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="mappingTable">
                                            <thead>
                                                <tr>
                                                    <th>文件列名</th>
                                                    <th>映射操作</th>
                                                    <th>数据库字段</th>
                                                </tr>
                                            </thead>
                                            <tbody id="mappingTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" id="confirmMappingBtn">
                                    <i class="bi bi-arrow-right"></i> 继续到数据导入
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第四步：导入数据 -->
                    <div class="tab-pane fade" id="import" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">执行数据导入</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">导入配置</label>
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <p><strong>文件:</strong> <span id="importFileName"></span></p>
                                            <p><strong>目标表:</strong> <span id="importTableName"></span></p>
                                            <p><strong>映射关系:</strong></p>
                                            <ul id="importMappingList"></ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success btn-lg" id="executeImportBtn">
                                    <i class="bi bi-database-check"></i> 执行导入
                                </button>
                                
                                <div id="importResult" class="mt-3" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let uploadedFileInfo = null;
        let previewData = null;
        let tableList = [];
        let selectedTable = null;
        let tableStructure = null;
        let mappingConfig = {};

        // 页面加载完成后初始化
        $(document).ready(function() {
            // 初始化事件监听器
            initEventListeners();
            
            // 获取数据库表列表
            loadTableList();
        });

        // 初始化事件监听器
        function initEventListeners() {
            // 文件上传表单提交
            $('#uploadForm').on('submit', function(e) {
                e.preventDefault();
                uploadFile();
            });
            
            // 确认预览按钮点击
            $('#confirmPreviewBtn').on('click', function() {
                enableTab('mapping-tab');
                $('#mapping-tab').tab('show');
            });
            
            // 目标表选择变化
            $('#targetTableSelect').on('change', function() {
                const tableName = $(this).val();
                if (tableName) {
                    loadTableStructure(tableName);
                } else {
                    // 清空字段列表和映射表
                    tableStructure = null;
                    renderDbColumnsList();
                    renderMappingTable();
                }
            });
            
            // 确认映射按钮点击
            $('#confirmMappingBtn').on('click', function() {
                collectMappingConfig();
                updateImportConfigDisplay();
                enableTab('import-tab');
                $('#import-tab').tab('show');
            });
            
            // 执行导入按钮点击
            $('#executeImportBtn').on('click', function() {
                executeImport();
            });
        }

        // 启用标签页
        function enableTab(tabId) {
            $('#' + tabId).removeClass('disabled');
        }

        // 获取数据库表列表
        function loadTableList() {
            $.ajax({
                url: '/api/get_tables',
                method: 'GET',
                success: function(response) {
                    if (response.code === 200) {
                        tableList = response.data;
                        const select = $('#targetTableSelect');
                        select.empty();
                        select.append('<option value="">请选择...</option>');
                        tableList.forEach(function(table) {
                            // 确保正确显示Unicode字符
                            const displayText = typeof table === 'string' ? decodeUnicode(table) : table;
                            select.append(`<option value="${table}">${displayText}</option>`);
                        });
                    } else {
                        alert('获取表列表失败: ' + response.msg);
                    }
                },
                error: function() {
                    alert('获取表列表时发生网络错误');
                }
            });
        }

        // 获取表结构
        function loadTableStructure(tableName) {
            $.ajax({
                url: `/api/get_table_structure/${tableName}`,
                method: 'GET',
                success: function(response) {
                    if (response.code === 200) {
                        selectedTable = tableName;
                        
                        // 设置tableStructure
                        if (response.data && response.data.columns) {
                            tableStructure = response.data.columns;
                        } else {
                            tableStructure = [];
                        }
                        
                        renderDbColumnsList();
                        renderMappingTable();
                    } else {
                        alert('获取表结构失败: ' + response.msg);
                        tableStructure = [];
                        renderDbColumnsList();
                        renderMappingTable();
                    }
                },
                error: function() {
                    alert('获取表结构时发生网络错误');
                    tableStructure = [];
                    renderDbColumnsList();
                    renderMappingTable();
                }
            });
        }

        // 上传文件
        function uploadFile() {
            const fileInput = $('#fileInput')[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('请选择要上传的文件');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            $('#uploadBtn').prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> 上传中...');
            
            $.ajax({
                url: '/api/upload_file',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#uploadBtn').prop('disabled', false).html('<i class="bi bi-upload"></i> 上传文件');
                    
                    if (response.code === 200) {
                        uploadedFileInfo = response.data;
                        $('#fileName').text(decodeUnicode(uploadedFileInfo.file_name));
                        $('#uploadResult').show();
                        
                        // 自动预览数据
                        previewFileData();
                        
                        // 启用下一步标签
                        enableTab('preview-tab');
                    } else {
                        alert('文件上传失败: ' + response.msg);
                    }
                },
                error: function() {
                    $('#uploadBtn').prop('disabled', false).html('<i class="bi bi-upload"></i> 上传文件');
                    alert('文件上传时发生网络错误');
                }
            });
        }

        // 预览文件数据
        function previewFileData() {
            if (!uploadedFileInfo) return;
            
            $.ajax({
                url: '/api/preview_file_data',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    file_path: uploadedFileInfo.file_path,
                    file_type: uploadedFileInfo.file_type
                }),
                success: function(response) {
                    if (response.code === 200) {
                        previewData = response.data;
                        renderPreviewData();
                        
                        // 显示预览标签页
                        $('#preview-tab').tab('show');
                    } else {
                        alert('数据预览失败: ' + response.msg + ' (错误代码: ' + response.code + ')');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('数据预览时发生网络错误:', xhr, status, error);
                    let errorMessage = '数据预览时发生网络错误';
                    if (xhr.responseText) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage = response.msg || errorMessage;
                        } catch (e) {
                            // 如果无法解析JSON，就显示原始响应文本
                            errorMessage = '服务器返回错误: ' + xhr.responseText;
                        }
                    }
                    alert(errorMessage);
                }
            });
        }

        // 渲染预览数据
        function renderPreviewData() {
            if (!previewData) return;
            
            // 显示文件信息
            $('#fileInfo').html(`
                <p><strong>文件名:</strong> ${decodeUnicode(uploadedFileInfo.file_name)}</p>
                <p><strong>总行数:</strong> ${previewData.total_rows}</p>
                <p><strong>列数:</strong> ${previewData.columns.length}</p>
            `);
            
            // 渲染表头
            const thead = $('#previewTableHead');
            const headerRow = $('<tr></tr>');
            previewData.columns.forEach(function(column) {
                // 确保正确显示Unicode字符
                const decodedColumn = typeof column === 'string' ? decodeUnicode(column) : column;
                headerRow.append(`<th>${decodedColumn}</th>`);
            });
            thead.empty().append(headerRow);
            
            // 渲染数据行
            const tbody = $('#previewTableBody');
            tbody.empty();
            previewData.preview_data.forEach(function(row) {
                const dataRow = $('<tr></tr>');
                previewData.columns.forEach(function(column) {
                    let cellValue = row[column] !== undefined ? row[column] : '';
                    // 确保正确显示Unicode字符
                    if (typeof cellValue === 'string') {
                        cellValue = decodeUnicode(cellValue);
                    }
                    dataRow.append(`<td>${cellValue}</td>`);
                });
                tbody.append(dataRow);
            });
            
            // 渲染文件列列表
            renderFileColumnsList();
        }

        // 渲染文件列列表
        function renderFileColumnsList() {
            if (!previewData) return;
            
            const container = $('#fileColumnsList');
            container.empty();
            
            previewData.columns.forEach(function(column) {
                // 确保正确显示Unicode字符
                const decodedColumn = typeof column === 'string' ? decodeUnicode(column) : column;
                container.append(`
                    <div class="form-check">
                        <input class="form-check-input file-column-checkbox" type="checkbox" 
                               value="${column}" id="fileCol_${column}" checked>
                        <label class="form-check-label" for="fileCol_${column}">
                            ${decodedColumn}
                        </label>
                    </div>
                `);
            });
        }

        // 渲染数据库字段列表
        function renderDbColumnsList() {
            const container = $('#dbColumnsList');
            container.empty();
            
            // 检查tableStructure是否存在且为数组
            if (!tableStructure || !Array.isArray(tableStructure) || tableStructure.length === 0) {
                container.html('<p class="text-muted">暂无字段信息</p>');
                return;
            }
            
            tableStructure.forEach(function(column) {
                // 检查字段对象是否有效
                if (!column || typeof column !== 'object') {
                    return;
                }
                
                // 检查必要的字段是否存在
                if (!column.hasOwnProperty('COLUMN_NAME')) {
                    return;
                }
                
                // 确保正确显示Unicode字符
                const decodedName = typeof column.COLUMN_NAME === 'string' ? 
                    decodeUnicode(column.COLUMN_NAME) : column.COLUMN_NAME;
                const decodedComment = column.COLUMN_COMMENT ? 
                    (typeof column.COLUMN_COMMENT === 'string' ? 
                     decodeUnicode(column.COLUMN_COMMENT) : column.COLUMN_COMMENT) : '无注释';
                
                const divElement = $(`
                    <div class="form-check">
                        <input class="form-check-input db-column-radio" type="radio" 
                               name="dbColumn" value="${column.COLUMN_NAME}" 
                               id="dbCol_${column.COLUMN_NAME}">
                        <label class="form-check-label" for="dbCol_${column.COLUMN_NAME}">
                            ${decodedName} (${decodedComment})
                        </label>
                    </div>
                `);
                container.append(divElement);
            });
        }

        // 渲染映射表
        function renderMappingTable() {
            const tbody = $('#mappingTableBody');
            tbody.empty();
            
            // 检查必要数据是否存在
            if (!previewData || !tableStructure) {
                tbody.html('<tr><td colspan="3" class="text-center text-muted">请先选择目标数据表</td></tr>');
                return;
            }
            
            if (!Array.isArray(tableStructure) || tableStructure.length === 0) {
                tbody.html('<tr><td colspan="3" class="text-center text-muted">目标数据表无字段信息</td></tr>');
                return;
            }
            
            if (!Array.isArray(previewData.columns)) {
                tbody.html('<tr><td colspan="3" class="text-center text-muted">文件列信息异常</td></tr>');
                return;
            }
            
            previewData.columns.forEach(function(fileColumn) {
                // 确保正确显示Unicode字符
                const decodedFileColumn = typeof fileColumn === 'string' ? 
                    decodeUnicode(fileColumn) : fileColumn;
                const row = $(`
                    <tr>
                        <td>${decodedFileColumn}</td>
                        <td class="text-center">
                            <i class="bi bi-arrow-right"></i>
                        </td>
                        <td>
                            <select class="form-select mapping-select" data-file-column="${fileColumn}">
                                <option value="">不映射</option>
                            </select>
                        </td>
                    </tr>
                `);
                
                // 添加数据库字段选项
                const select = row.find('.mapping-select');
                tableStructure.forEach(function(dbColumn) {
                    // 检查字段对象是否有效
                    if (!dbColumn || typeof dbColumn !== 'object') {
                        return;
                    }
                    
                    // 检查必要的字段是否存在
                    if (!dbColumn.hasOwnProperty('COLUMN_NAME')) {
                        return;
                    }
                    
                    // 确保正确显示Unicode字符
                    const decodedName = typeof dbColumn.COLUMN_NAME === 'string' ? 
                        decodeUnicode(dbColumn.COLUMN_NAME) : dbColumn.COLUMN_NAME;
                    const decodedComment = dbColumn.COLUMN_COMMENT ? 
                        (typeof dbColumn.COLUMN_COMMENT === 'string' ? 
                         decodeUnicode(dbColumn.COLUMN_COMMENT) : dbColumn.COLUMN_COMMENT) : '无注释';
                    
                    const option = new Option(`${decodedName} (${decodedComment})`, dbColumn.COLUMN_NAME);
                    select.append(option);
                });
                
                tbody.append(row);
            });
        }

        // 收集映射配置
        function collectMappingConfig() {
            mappingConfig = {};
            
            $('.mapping-select').each(function() {
                const fileColumn = $(this).data('file-column');
                const dbColumn = $(this).val();
                
                if (dbColumn) {
                    mappingConfig[fileColumn] = dbColumn;
                }
            });
        }

        // 更新导入配置显示
        function updateImportConfigDisplay() {
            $('#importFileName').text(decodeUnicode(uploadedFileInfo.file_name));
            $('#importTableName').text(decodeUnicode(selectedTable));
            
            const mappingList = $('#importMappingList');
            mappingList.empty();
            
            Object.keys(mappingConfig).forEach(function(fileColumn) {
                const dbColumn = mappingConfig[fileColumn];
                // 确保正确显示Unicode字符
                const decodedFileColumn = typeof fileColumn === 'string' ? 
                    decodeUnicode(fileColumn) : fileColumn;
                const decodedDbColumn = typeof dbColumn === 'string' ? 
                    decodeUnicode(dbColumn) : dbColumn;
                mappingList.append(`<li>${decodedFileColumn} → ${decodedDbColumn}</li>`);
            });
        }

        // 执行导入
        function executeImport() {
            if (!uploadedFileInfo || !selectedTable) {
                alert('缺少必要的导入信息');
                return;
            }
            
            $('#executeImportBtn').prop('disabled', true)
                .html('<i class="bi bi-arrow-clockwise"></i> 导入中...');
            
            $.ajax({
                url: '/api/import_data',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    file_path: uploadedFileInfo.file_path,
                    file_type: uploadedFileInfo.file_type,
                    table_name: selectedTable,
                    mapping_config: mappingConfig
                }),
                success: function(response) {
                    $('#executeImportBtn').prop('disabled', false)
                        .html('<i class="bi bi-database-check"></i> 执行导入');
                    
                    const resultDiv = $('#importResult');
                    resultDiv.show();
                    
                    if (response.code === 200) {
                        resultDiv.removeClass('alert-danger').addClass('alert-success')
                            .html(`
                                <i class="bi bi-check-circle-fill"></i>
                                数据导入成功！共处理 ${response.data.total_rows} 行数据，
                                成功导入 ${response.data.inserted_rows} 行。
                            `);
                    } else {
                        resultDiv.removeClass('alert-success').addClass('alert-danger')
                            .html(`<i class="bi bi-exclamation-triangle-fill"></i> 数据导入失败: ${response.msg}`);
                    }
                },
                error: function() {
                    $('#executeImportBtn').prop('disabled', false)
                        .html('<i class="bi bi-database-check"></i> 执行导入');
                    
                    $('#importResult').removeClass('alert-success').addClass('alert-danger')
                        .html('<i class="bi bi-exclamation-triangle-fill"></i> 数据导入时发生网络错误')
                        .show();
                }
            });
        }

        // 解码Unicode转义序列的函数
        function decodeUnicode(str) {
            if (typeof str !== 'string') return str;
            
            try {
                // 尝试解码Unicode转义序列
                return str.replace(/\\u[\dA-F]{4}/gi, function (match) {
                    return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
                });
            } catch (e) {
                // 如果解码失败，返回原始字符串
                console.error('Unicode解码失败:', e);
                return str;
            }
        }
    </script>
</body>
</html>