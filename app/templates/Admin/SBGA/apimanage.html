<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIç®¡ç†ä¸æµ‹è¯•å·¥å…·</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            height: 100vh;
            overflow-y: auto;
            background-color: #fff;
            border-right: 1px solid #dee2e6;
        }
        .main-content {
            height: 100vh;
            overflow-y: auto;
        }
        .api-item, .folder-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .api-item:hover, .folder-item:hover {
            background-color: #e9ecef;
        }
        .api-item.active, .folder-item.active {
            background-color: #007bff;
            color: white;
        }
        .request-panel, .response-panel {
            height: 40vh;
            overflow-y: auto;
        }
        .nav-tabs .nav-link {
            cursor: pointer;
        }
        .kv-row {
            display: flex;
            margin-bottom: 5px;
            gap: 5px;
        }
        .kv-row input {
            flex: 1;
        }
        .btn-add {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
        }
        .btn-remove {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
        }
        .method-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-get {
            background-color: #17a2b8;
        }
        .badge-post {
            background-color: #28a745;
        }
        .folder-children {
            padding-left: 20px;
        }
        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .folder-name {
            flex-grow: 1;
        }
        .folder-actions {
            display: none;
        }
        .folder-item:hover .folder-actions {
            display: block;
        }
        .folder-select {
            max-width: 200px;
        }
        .add-subfolder {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§è¾¹æ  - APIåˆ—è¡¨ -->
            <div class="col-md-3 sidebar">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <h5 class="mb-0">APIæ¥å£åˆ—è¡¨</h5>
                    <div>
                        <button class="btn btn-primary btn-sm me-1" id="addFolderBtn">æ–‡ä»¶å¤¹</button>
                        <button class="btn btn-primary btn-sm" id="addApiBtn">+</button>
                    </div>
                </div>
                <div class="p-2">
                    <input type="text" class="form-control form-control-sm mb-2" placeholder="æœç´¢æ¥å£..." id="searchApi">
                </div>
                <div id="apiList">
                    <!-- APIåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                </div>
            </div>
            
            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="col-md-9 main-content">
                <!-- APIè¯¦æƒ…å’Œæµ‹è¯•é¢æ¿ -->
                <div id="apiDetailPanel">
                    <div class="p-3 border-bottom">
                        <h4>APIæ¥å£è¯¦æƒ…</h4>
                    </div>
                    
                    <div class="p-3">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        <select class="form-select" id="methodSelect">
                                            <option value="GET">GET</option>
                                            <option value="POST">POST</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="urlInput" placeholder="è¯·è¾“å…¥APIåœ°å€ï¼Œå¦‚ï¼šhttps://api.example.com/users">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-success w-100" id="sendRequestBtn">å‘é€</button>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <input type="text" class="form-control" id="nameInput" placeholder="æ¥å£åç§°ï¼ˆå¯é€‰ï¼‰">
                                    <div class="mt-2">
                                        <label class="form-label">é€‰æ‹©æ–‡ä»¶å¤¹</label>
                                        <select class="form-select folder-select" id="folderSelect">
                                            <option value="">æœªåˆ†ç±»</option>
                                            <!-- æ–‡ä»¶å¤¹é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¯·æ±‚é…ç½® -->
                        <ul class="nav nav-tabs" id="requestTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="params-tab" data-bs-toggle="tab" data-bs-target="#params" type="button" role="tab">Params</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="headers-tab" data-bs-toggle="tab" data-bs-target="#headers" type="button" role="tab">Headers</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="body-tab" data-bs-toggle="tab" data-bs-target="#body" type="button" role="tab">Body</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content border border-top-0 p-3 mb-3">
                            <!-- Params Tab -->
                            <div class="tab-pane fade show active" id="params" role="tabpanel">
                                <div id="paramsContainer">
                                    <!-- Paramsé¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                                </div>
                                <button class="btn btn-add mt-2" id="addParamBtn">+ æ·»åŠ å‚æ•°</button>
                            </div>
                            
                            <!-- Headers Tab -->
                            <div class="tab-pane fade" id="headers" role="tabpanel">
                                <div id="headersContainer">
                                    <!-- Headersé¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                                </div>
                                <button class="btn btn-add mt-2" id="addHeaderBtn">+ æ·»åŠ Header</button>
                            </div>
                            
                            <!-- Body Tab -->
                            <div class="tab-pane fade" id="body" role="tabpanel">
                                <select class="form-select mb-2" id="bodyTypeSelect">
                                    <option value="none">æ— </option>
                                    <option value="raw">Raw</option>
                                </select>
                                <div id="bodyRawContainer" style="display:none;">
                                    <select class="form-select mb-2" id="rawTypeSelect">
                                        <option value="text/plain">Text</option>
                                        <option value="application/json" selected>JSON</option>
                                        <option value="application/xml">XML</option>
                                    </select>
                                    <textarea class="form-control" id="bodyTextarea" rows="8" placeholder="è¯·æ±‚ä½“å†…å®¹"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="mb-3">
                            <button class="btn btn-primary" id="saveApiBtn">ä¿å­˜æ¥å£</button>
                            <button class="btn btn-secondary" id="resetApiBtn">é‡ç½®</button>
                            <button class="btn btn-danger" id="deleteApiBtn" style="display:none;">åˆ é™¤æ¥å£</button>
                        </div>
                        
                        <!-- å“åº”é¢æ¿ -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">å“åº”ç»“æœ</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="response-panel" id="responsePanel">
                                    <div class="p-3 text-muted">
                                        å‘é€è¯·æ±‚åï¼Œå“åº”å†…å®¹å°†åœ¨æ­¤å¤„æ˜¾ç¤º
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶å¤¹è¯¦æƒ…é¢æ¿ -->
                <div id="folderDetailPanel" style="display:none;">
                    <div class="p-3 border-bottom">
                        <h4>æ–‡ä»¶å¤¹è¯¦æƒ…</h4>
                    </div>
                    
                    <div class="p-3">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">æ–‡ä»¶å¤¹åç§°</label>
                                    <input type="text" class="form-control" id="folderNameInput" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                    <textarea class="form-control" id="folderDescInput" rows="3" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹æè¿°"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button class="btn btn-primary" id="saveFolderBtn">ä¿å­˜æ–‡ä»¶å¤¹</button>
                            <button class="btn btn-secondary" id="resetFolderBtn">é‡ç½®</button>
                            <button class="btn btn-danger" id="deleteFolderBtn" style="display:none;">åˆ é™¤æ–‡ä»¶å¤¹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let apiList = [];
        let folderList = [];
        let currentApi = null;
        let currentFolder = null;
        let nextId = 1;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadApiList();
            loadFolderList();
            bindEvents();
            addParamRow();
            addHeaderRow();
        });

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('addApiBtn').addEventListener('click', addNewApi);
            document.getElementById('addFolderBtn').addEventListener('click', addNewFolder);
            document.getElementById('addParamBtn').addEventListener('click', addParamRow);
            document.getElementById('addHeaderBtn').addEventListener('click', addHeaderRow);
            document.getElementById('sendRequestBtn').addEventListener('click', sendRequest);
            document.getElementById('saveApiBtn').addEventListener('click', saveApi);
            document.getElementById('saveFolderBtn').addEventListener('click', saveFolder);
            document.getElementById('resetApiBtn').addEventListener('click', resetApiForm);
            document.getElementById('resetFolderBtn').addEventListener('click', resetFolderForm);
            document.getElementById('deleteApiBtn').addEventListener('click', deleteApi);
            document.getElementById('deleteFolderBtn').addEventListener('click', deleteFolder);
            document.getElementById('bodyTypeSelect').addEventListener('change', toggleBodyRaw);
            document.getElementById('searchApi').addEventListener('input', filterApiList);
        }

        // åˆ‡æ¢Body Rawæ˜¾ç¤º
        function toggleBodyRaw() {
            const bodyType = document.getElementById('bodyTypeSelect').value;
            const rawContainer = document.getElementById('bodyRawContainer');
            rawContainer.style.display = bodyType === 'raw' ? 'block' : 'none';
        }

        // æ·»åŠ å‚æ•°è¡Œ
        function addParamRow(key = '', value = '') {
            const container = document.getElementById('paramsContainer');
            const row = document.createElement('div');
            row.className = 'kv-row';
            row.innerHTML = `
                <input type="text" class="form-control form-control-sm param-key" placeholder="å‚æ•°å" value="${key}">
                <input type="text" class="form-control form-control-sm param-value" placeholder="å‚æ•°å€¼" value="${value}">
                <button class="btn-remove" onclick="this.parentElement.remove()">-</button>
            `;
            container.appendChild(row);
        }

        // æ·»åŠ Headerè¡Œ
        function addHeaderRow(key = '', value = '') {
            const container = document.getElementById('headersContainer');
            const row = document.createElement('div');
            row.className = 'kv-row';
            row.innerHTML = `
                <input type="text" class="form-control form-control-sm header-key" placeholder="Headerå" value="${key}">
                <input type="text" class="form-control form-control-sm header-value" placeholder="Headerå€¼" value="${value}">
                <button class="btn-remove" onclick="this.parentElement.remove()">-</button>
            `;
            container.appendChild(row);
        }

        // è·å–å‚æ•°åˆ—è¡¨
        function getParams() {
            const params = [];
            document.querySelectorAll('#paramsContainer .kv-row').forEach(row => {
                const keyInput = row.querySelector('.param-key');
                const valueInput = row.querySelector('.param-value');
                if (keyInput && valueInput && keyInput.value) {
                    params.push({
                        key: keyInput.value,
                        value: valueInput.value
                    });
                }
            });
            return params;
        }

        // è·å–Headersåˆ—è¡¨
        function getHeaders() {
            const headers = [];
            document.querySelectorAll('#headersContainer .kv-row').forEach(row => {
                const keyInput = row.querySelector('.header-key');
                const valueInput = row.querySelector('.header-value');
                if (keyInput && valueInput && keyInput.value) {
                    headers.push({
                        key: keyInput.value,
                        value: valueInput.value
                    });
                }
            });
            return headers;
        }

        // åŠ è½½APIåˆ—è¡¨
        function loadApiList() {
            fetch('/api/api-list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        apiList = data.data;
                        renderApiList();
                        if (apiList.length > 0 && !currentFolder) {
                            loadApiDetail(apiList[0]);
                        } else {
                            resetApiForm();
                        }
                    } else {
                        alert('åŠ è½½APIåˆ—è¡¨å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½APIåˆ—è¡¨å‡ºé”™:', error);
                    alert('åŠ è½½APIåˆ—è¡¨å‡ºé”™: ' + error.message);
                });
        }

        // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
        function loadFolderList() {
            fetch('/api/folder-list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        folderList = data.data;
                        renderFolderSelect();
                        renderApiList();
                    } else {
                        alert('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å‡ºé”™:', error);
                    alert('åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨å‡ºé”™: ' + error.message);
                });
        }

        // æ¸²æŸ“æ–‡ä»¶å¤¹é€‰æ‹©ä¸‹æ‹‰æ¡†
        function renderFolderSelect() {
            const select = document.getElementById('folderSelect');
            // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹"æœªåˆ†ç±»"
            select.innerHTML = '<option value="">æœªåˆ†ç±»</option>';
            
            // æ„å»ºæ–‡ä»¶å¤¹æ ‘ç»“æ„
            function buildFolderTree(folders, parentId = null) {
                return folders
                    .filter(folder => (parentId ? folder.parentId == parentId : !folder.parentId))
                    .map(folder => {
                        const children = buildFolderTree(folders, folder.id);
                        return { ...folder, children };
                    });
            }
            
            // æ¸²æŸ“æ–‡ä»¶å¤¹é€‰é¡¹
            function renderFolderOptions(folderTree, level = 0) {
                folderTree.forEach(folder => {
                    const indent = '\u00A0'.repeat(level * 4); // ä½¿ç”¨ä¸é—´æ–­ç©ºæ ¼
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = `${indent}ğŸ“ ${folder.name}`;
                    select.appendChild(option);
                    
                    // æ¸²æŸ“å­æ–‡ä»¶å¤¹é€‰é¡¹
                    if (folder.children && folder.children.length > 0) {
                        renderFolderOptions(folder.children, level + 1);
                    }
                });
            }
            
            // æ„å»ºå¹¶æ¸²æŸ“æ–‡ä»¶å¤¹é€‰é¡¹
            const folderTree = buildFolderTree(folderList);
            renderFolderOptions(folderTree);
        }

        // æ¸²æŸ“APIåˆ—è¡¨
        function renderApiList(filter = '') {
            const container = document.getElementById('apiList');
            container.innerHTML = '';
            
            // æ„å»ºæ–‡ä»¶å¤¹æ ‘ç»“æ„
            function buildFolderTree(folders, parentId = null) {
                return folders
                    .filter(folder => (parentId ? folder.parentId == parentId : !folder.parentId))
                    .map(folder => {
                        const children = buildFolderTree(folders, folder.id);
                        return { ...folder, children };
                    });
            }
            
            // æ¸²æŸ“æ–‡ä»¶å¤¹æ ‘
            function renderFolderTree(folderTree, level = 0) {
                folderTree.forEach(folder => {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-item';
                    if (currentFolder && currentFolder.id === folder.id) {
                        folderItem.classList.add('active');
                    }
                    
                    const indent = '&nbsp;'.repeat(level * 4);
                    
                    folderItem.innerHTML = `
                        <div class="folder-header">
                            <div class="folder-name">${indent}ğŸ“ ${folder.name}</div>
                            <div class="folder-actions">
                                <button class="btn btn-sm btn-outline-primary add-subfolder" data-id="${folder.id}">å­æ–‡ä»¶å¤¹</button>
                                <button class="btn btn-sm btn-outline-primary edit-folder" data-id="${folder.id}">ç¼–è¾‘</button>
                            </div>
                        </div>
                        <div class="small text-muted mt-1">${folder.description || ''}</div>
                    `;
                    
                    folderItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('edit-folder') && !e.target.classList.contains('add-subfolder')) {
                            loadFolderDetail(folder);
                        }
                    });
                    
                    // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                    folderItem.querySelector('.edit-folder').addEventListener('click', (e) => {
                        e.stopPropagation();
                        loadFolderDetail(folder);
                    });
                    
                    // ç»‘å®šæ·»åŠ å­æ–‡ä»¶å¤¹æŒ‰é’®äº‹ä»¶
                    folderItem.querySelector('.add-subfolder').addEventListener('click', (e) => {
                        e.stopPropagation();
                        addNewSubFolder(folder.id);
                    });
                    
                    container.appendChild(folderItem);
                    
                    // æ¸²æŸ“è¯¥æ–‡ä»¶å¤¹ä¸‹çš„API
                    const folderApis = apiList.filter(api => api.folderId == folder.id);
                    if (folderApis.length > 0) {
                        const childrenContainer = document.createElement('div');
                        childrenContainer.className = 'folder-children';
                        
                        folderApis.forEach(api => {
                            if (!filter || api.name.toLowerCase().includes(filter.toLowerCase()) || 
                                api.url.toLowerCase().includes(filter.toLowerCase())) {
                                const apiItem = document.createElement('div');
                                apiItem.className = 'api-item';
                                if (currentApi && currentApi.id === api.id) {
                                    apiItem.classList.add('active');
                                }
                                
                                const methodClass = api.method === 'POST' ? 'badge-post' : 'badge-get';
                                
                                const apiIndent = '&nbsp;'.repeat((level + 1) * 4);
                                
                                apiItem.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="method-badge ${methodClass}">${api.method}</span>
                                        <span class="flex-grow-1 ms-2">${apiIndent}${api.name || 'æœªå‘½åæ¥å£'}</span>
                                    </div>
                                    <div class="small text-muted mt-1 text-truncate">${apiIndent}${api.url}</div>
                                `;
                                
                                apiItem.addEventListener('click', () => loadApiDetail(api));
                                childrenContainer.appendChild(apiItem);
                            }
                        });
                        
                        if (childrenContainer.children.length > 0) {
                            container.appendChild(childrenContainer);
                        }
                    }
                    
                    // æ¸²æŸ“å­æ–‡ä»¶å¤¹
                    if (folder.children && folder.children.length > 0) {
                        renderFolderTree(folder.children, level + 1);
                    }
                });
            }
            
            // æ„å»ºå¹¶æ¸²æŸ“æ–‡ä»¶å¤¹æ ‘
            const folderTree = buildFolderTree(folderList);
            renderFolderTree(folderTree);
            
            // æ¸²æŸ“æœªåˆ†ç±»çš„API
            const ungroupedApis = apiList.filter(api => !api.folderId || 
                !folderList.some(folder => folder.id == api.folderId));
            
            if (ungroupedApis.length > 0) {
                const ungroupedTitle = document.createElement('div');
                ungroupedTitle.className = 'px-3 py-2 fw-bold border-bottom';
                ungroupedTitle.textContent = 'æœªåˆ†ç±»';
                container.appendChild(ungroupedTitle);
                
                ungroupedApis.forEach(api => {
                    if (!filter || api.name.toLowerCase().includes(filter.toLowerCase()) || 
                        api.url.toLowerCase().includes(filter.toLowerCase())) {
                        const apiItem = document.createElement('div');
                        apiItem.className = 'api-item';
                        if (currentApi && currentApi.id === api.id) {
                            apiItem.classList.add('active');
                        }
                        
                        const methodClass = api.method === 'POST' ? 'badge-post' : 'badge-get';
                        
                        apiItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="method-badge ${methodClass}">${api.method}</span>
                                <span class="flex-grow-1 ms-2">${api.name || 'æœªå‘½åæ¥å£'}</span>
                            </div>
                            <div class="small text-muted mt-1 text-truncate">${api.url}</div>
                        `;
                        
                        apiItem.addEventListener('click', () => loadApiDetail(api));
                        container.appendChild(apiItem);
                    }
                });
            }
        }

        // è¿‡æ»¤APIåˆ—è¡¨
        function filterApiList() {
            const filter = document.getElementById('searchApi').value;
            renderApiList(filter);
        }

        // åŠ è½½APIè¯¦æƒ…
        function loadApiDetail(api) {
            // æ˜¾ç¤ºAPIè¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'block';
            document.getElementById('folderDetailPanel').style.display = 'none';
            
            currentApi = {...api};
            currentFolder = null;
            
            document.getElementById('methodSelect').value = api.method || 'GET';
            document.getElementById('urlInput').value = api.url || '';
            document.getElementById('nameInput').value = api.name || '';
            document.getElementById('folderSelect').value = api.folderId || '';
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……å‚æ•°
            const paramsContainer = document.getElementById('paramsContainer');
            paramsContainer.innerHTML = '';
            if (api.params && api.params.length > 0) {
                api.params.forEach(param => {
                    addParamRow(param.key, param.value);
                });
            } else {
                addParamRow();
            }
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……Headers
            const headersContainer = document.getElementById('headersContainer');
            headersContainer.innerHTML = '';
            if (api.headers && api.headers.length > 0) {
                api.headers.forEach(header => {
                    addHeaderRow(header.key, header.value);
                });
            } else {
                addHeaderRow();
            }
            
            // è®¾ç½®Body
            document.getElementById('bodyTypeSelect').value = api.bodyType || 'none';
            document.getElementById('rawTypeSelect').value = api.rawType || 'application/json';
            document.getElementById('bodyTextarea').value = api.body || '';
            toggleBodyRaw();
            
            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            document.getElementById('deleteApiBtn').style.display = 'inline-block';
            document.getElementById('deleteFolderBtn').style.display = 'none';
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderApiList(document.getElementById('searchApi').value);
        }

        // åŠ è½½æ–‡ä»¶å¤¹è¯¦æƒ…
        function loadFolderDetail(folder) {
            // æ˜¾ç¤ºæ–‡ä»¶å¤¹è¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'none';
            document.getElementById('folderDetailPanel').style.display = 'block';
            
            currentFolder = {...folder};
            currentApi = null;
            
            document.getElementById('folderNameInput').value = folder.name || '';
            document.getElementById('folderDescInput').value = folder.description || '';
            
            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            document.getElementById('deleteFolderBtn').style.display = 'inline-block';
            document.getElementById('deleteApiBtn').style.display = 'none';
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderApiList(document.getElementById('searchApi').value);
        }

        // æ·»åŠ æ–°API
        function addNewApi() {
            // æ˜¾ç¤ºAPIè¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'block';
            document.getElementById('folderDetailPanel').style.display = 'none';
            
            const newApi = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºä¸´æ—¶ID
                name: '',
                method: 'GET',
                url: '',
                params: [],
                headers: [
                    {key: 'Content-Type', value: 'application/json'}
                ],
                bodyType: 'none',
                rawType: 'application/json',
                body: ''
            };
            
            // å¦‚æœå½“å‰åœ¨æ–‡ä»¶å¤¹è¯¦æƒ…ä¸­ï¼Œå°†æ–°APIé»˜è®¤åˆ†é…åˆ°è¯¥æ–‡ä»¶å¤¹
            if (currentFolder) {
                newApi.folderId = currentFolder.id;
            }
            
            currentApi = newApi;
            currentFolder = null;
            loadApiDetail(newApi);
        }

        // æ·»åŠ æ–°æ–‡ä»¶å¤¹
        function addNewFolder() {
            // æ˜¾ç¤ºæ–‡ä»¶å¤¹è¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'none';
            document.getElementById('folderDetailPanel').style.display = 'block';
            
            const newFolder = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºä¸´æ—¶ID
                name: '',
                description: '',
                parentId: null  // æ ¹çº§åˆ«çš„æ–‡ä»¶å¤¹
            };
            
            currentFolder = newFolder;
            currentApi = null;
            loadFolderDetail(newFolder);
        }

        // æ·»åŠ æ–°çš„å­æ–‡ä»¶å¤¹
        function addNewSubFolder(parentId) {
            // æ˜¾ç¤ºæ–‡ä»¶å¤¹è¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'none';
            document.getElementById('folderDetailPanel').style.display = 'block';
            
            const newFolder = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºä¸´æ—¶ID
                name: '',
                description: '',
                parentId: parentId  // è®¾ç½®çˆ¶æ–‡ä»¶å¤¹ID
            };
            
            currentFolder = newFolder;
            currentApi = null;
            loadFolderDetail(newFolder);
        }

        // é‡ç½®APIè¡¨å•
        function resetApiForm() {
            currentApi = null;
            currentFolder = null;
            
            document.getElementById('methodSelect').value = 'GET';
            document.getElementById('urlInput').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('folderSelect').value = '';
            
            // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ é»˜è®¤å‚æ•°è¡Œ
            const paramsContainer = document.getElementById('paramsContainer');
            paramsContainer.innerHTML = '';
            addParamRow();
            
            // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ é»˜è®¤Headersè¡Œ
            const headersContainer = document.getElementById('headersContainer');
            headersContainer.innerHTML = '';
            addHeaderRow('Content-Type', 'application/json');
            
            // é‡ç½®Body
            document.getElementById('bodyTypeSelect').value = 'none';
            document.getElementById('rawTypeSelect').value = 'application/json';
            document.getElementById('bodyTextarea').value = '';
            toggleBodyRaw();
            
            // éšè—åˆ é™¤æŒ‰é’®
            document.getElementById('deleteApiBtn').style.display = 'none';
            document.getElementById('deleteFolderBtn').style.display = 'none';
            
            // æ˜¾ç¤ºAPIè¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'block';
            document.getElementById('folderDetailPanel').style.display = 'none';
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderApiList(document.getElementById('searchApi').value);
        }

        // é‡ç½®æ–‡ä»¶å¤¹è¡¨å•
        function resetFolderForm() {
            currentFolder = null;
            currentApi = null;
            
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderDescInput').value = '';
            
            // éšè—åˆ é™¤æŒ‰é’®
            document.getElementById('deleteFolderBtn').style.display = 'none';
            document.getElementById('deleteApiBtn').style.display = 'none';
            
            // æ˜¾ç¤ºAPIè¯¦æƒ…é¢æ¿
            document.getElementById('apiDetailPanel').style.display = 'block';
            document.getElementById('folderDetailPanel').style.display = 'none';
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderApiList(document.getElementById('searchApi').value);
        }

        // ä¿å­˜API
        function saveApi() {
            const apiData = {
                id: currentApi ? currentApi.id : Date.now(),
                name: document.getElementById('nameInput').value,
                method: document.getElementById('methodSelect').value,
                url: document.getElementById('urlInput').value,
                params: getParams(),
                headers: getHeaders(),
                bodyType: document.getElementById('bodyTypeSelect').value,
                rawType: document.getElementById('rawTypeSelect').value,
                body: document.getElementById('bodyTextarea').value,
                folderId: document.getElementById('folderSelect').value || null
            };
            
            if (!apiData.url) {
                alert('è¯·è¾“å…¥APIåœ°å€');
                return;
            }
            
            // å¦‚æœæ˜¯æ–°APIæˆ–è€…IDæ˜¯ä¸´æ—¶çš„ï¼Œåˆ™æ·»åŠ ï¼›å¦åˆ™æ›´æ–°
            const isNewApi = !currentApi || !apiList.some(api => api.id === apiData.id && typeof api.id === 'number');
            
            const url = isNewApi ? '/api/add-api' : '/api/update-api';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(apiData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ä¿å­˜æˆåŠŸ');
                    if (data.data) {
                        currentApi = data.data;
                    }
                    loadApiList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å‡ºé”™:', error);
                alert('ä¿å­˜å‡ºé”™: ' + error.message);
            });
        }

        // ä¿å­˜æ–‡ä»¶å¤¹
        function saveFolder() {
            const folderData = {
                id: currentFolder ? currentFolder.id : Date.now(),
                name: document.getElementById('folderNameInput').value,
                description: document.getElementById('folderDescInput').value,
                parentId: currentFolder && currentFolder.parentId !== undefined ? currentFolder.parentId : null
            };
            
            if (!folderData.name) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
                return;
            }
            
            // å¦‚æœæ˜¯æ–°æ–‡ä»¶å¤¹æˆ–è€…IDæ˜¯ä¸´æ—¶çš„ï¼Œåˆ™æ·»åŠ ï¼›å¦åˆ™æ›´æ–°
            const isNewFolder = !currentFolder || !folderList.some(folder => folder.id === folderData.id && typeof folder.id === 'number');
            
            const url = isNewFolder ? '/api/add-folder' : '/api/update-folder';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(folderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ä¿å­˜æˆåŠŸ');
                    loadFolderList(); // é‡æ–°åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å‡ºé”™:', error);
                alert('ä¿å­˜å‡ºé”™: ' + error.message);
            });
        }

        // åˆ é™¤API
        function deleteApi() {
            if (!currentApi || !currentApi.id) {
                alert('æ²¡æœ‰é€‰ä¸­è¦åˆ é™¤çš„API');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå—ï¼Ÿ')) {
                return;
            }
            
            fetch('/api/delete-api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({id: currentApi.id})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadApiList(); // é‡æ–°åŠ è½½åˆ—è¡¨
                    resetApiForm(); // é‡ç½®è¡¨å•
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å‡ºé”™:', error);
                alert('åˆ é™¤å‡ºé”™: ' + error.message);
            });
        }

        // åˆ é™¤æ–‡ä»¶å¤¹
        function deleteFolder() {
            if (!currentFolder || !currentFolder.id) {
                alert('æ²¡æœ‰é€‰ä¸­è¦åˆ é™¤çš„æ–‡ä»¶å¤¹');
                return;
            }
            
            // è·å–è¦åˆ é™¤çš„æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å­æ–‡ä»¶å¤¹çš„ID
            function getAllChildFolderIds(parentId) {
                const childIds = [];
                folderList.forEach(folder => {
                    if (folder.parentId == parentId) {
                        childIds.push(folder.id);
                        childIds.push(...getAllChildFolderIds(folder.id));
                    }
                });
                return childIds;
            }
            
            const allDeleteIds = [currentFolder.id, ...getAllChildFolderIds(currentFolder.id)];
            const folderNames = folderList
                .filter(folder => allDeleteIds.includes(folder.id))
                .map(folder => folder.name)
                .join(', ');
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${currentFolder.name}" åŠå…¶æ‰€æœ‰å­æ–‡ä»¶å¤¹(${folderNames})å—ï¼Ÿè¿™äº›æ–‡ä»¶å¤¹ä¸‹çš„APIä¹Ÿå°†è¢«åˆ é™¤ã€‚`)) {
                return;
            }
            
            // åˆ é™¤æ‰€æœ‰ç›¸å…³æ–‡ä»¶å¤¹ä¸‹çš„API
            function deleteApisAndFolders(deleteIds) {
                if (deleteIds.length === 0) {
                    // æ‰€æœ‰APIå·²åˆ é™¤ï¼Œç°åœ¨åˆ é™¤æ–‡ä»¶å¤¹
                    fetch('/api/delete-folder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({id: currentFolder.id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('åˆ é™¤æˆåŠŸ');
                            loadFolderList(); // é‡æ–°åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
                            loadApiList(); // é‡æ–°åŠ è½½APIåˆ—è¡¨
                            resetFolderForm(); // é‡ç½®è¡¨å•
                        } else {
                            alert('åˆ é™¤å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('åˆ é™¤æ–‡ä»¶å¤¹å‡ºé”™:', error);
                        alert('åˆ é™¤æ–‡ä»¶å¤¹å‡ºé”™: ' + error.message);
                    });
                    return;
                }
                
                const folderId = deleteIds[0];
                fetch('/api/delete-api-by-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({folder_id: folderId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ç»§ç»­åˆ é™¤ä¸‹ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„API
                        deleteApisAndFolders(deleteIds.slice(1));
                    } else {
                        alert('åˆ é™¤APIå¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤APIå‡ºé”™:', error);
                    alert('åˆ é™¤APIå‡ºé”™: ' + error.message);
                });
            }
            
            // å¼€å§‹åˆ é™¤è¿‡ç¨‹
            deleteApisAndFolders(allDeleteIds);
        }

        // å‘é€è¯·æ±‚
        function sendRequest() {
            const requestData = {
                method: document.getElementById('methodSelect').value,
                url: document.getElementById('urlInput').value,
                headers: getHeaders(),
                params: getParams(),
                body: document.getElementById('bodyTextarea').value
            };
            
            if (!requestData.url) {
                alert('è¯·è¾“å…¥APIåœ°å€');
                return;
            }
            
            const responsePanel = document.getElementById('responsePanel');
            responsePanel.innerHTML = '<div class="p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> è¯·æ±‚ä¸­...</div>';
            
            fetch('/api/test-api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å°è¯•è§£æJSONå“åº”å†…å®¹ä»¥ä¾¿æ›´å¥½åœ°æ ¼å¼åŒ–æ˜¾ç¤º
                    let formattedContent = data.data.content;
                    try {
                        const parsedContent = JSON.parse(data.data.content);
                        formattedContent = JSON.stringify(parsedContent, null, 2);
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œä¿æŒåŸæ ·
                    }
                    
                    const responseHtml = `
                        <div class="p-3">
                            <div class="mb-3">
                                <h6>å“åº”çŠ¶æ€: <span class="badge bg-primary">${data.data.status_code}</span></h6>
                            </div>
                            <div class="mb-3">
                                <h6>å“åº”å†…å®¹:</h6>
                                <pre class="bg-light p-3 rounded">${escapeHtml(formattedContent)}</pre>
                            </div>
                        </div>
                    `;
                    responsePanel.innerHTML = responseHtml;
                } else {
                    responsePanel.innerHTML = `<div class="p-3 text-danger">è¯·æ±‚å¤±è´¥: ${escapeHtml(data.message)}</div>`;
                }
            })
            .catch(error => {
                responsePanel.innerHTML = `<div class="p-3 text-danger">è¯·æ±‚å‡ºé”™: ${escapeHtml(error.message)}</div>`;
            });
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ä¸”åŒ…å«Unicodeè½¬ä¹‰åºåˆ—ï¼Œåˆ™å…ˆè§£ç 
            if (typeof text === 'string') {
                try {
                    // å°è¯•è§£ç Unicodeåºåˆ—
                    text = text.replace(/\\u[\dA-F]{4}/gi, function (match) {
                        return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
                    });
                } catch (e) {
                    // å¦‚æœè§£ç å¤±è´¥ï¼Œä¿æŒåŸå§‹æ–‡æœ¬
                }
            }
            
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>